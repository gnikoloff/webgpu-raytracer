var Ci=Object.defineProperty;var Ni=(Ee,te,ye)=>te in Ee?Ci(Ee,te,{enumerable:!0,configurable:!0,writable:!0,value:ye}):Ee[te]=ye;var Jt=(Ee,te,ye)=>(Ni(Ee,typeof te!="symbol"?te+"":te,ye),ye);(async()=>{(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();function Ee(t){if(t&&!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}function te(t,e){var n=t.__state.conversionName.toString(),r=Math.round(t.r),s=Math.round(t.g),i=Math.round(t.b),a=t.a,u=Math.round(t.h),d=t.s.toFixed(1),m=t.v.toFixed(1);if(e||n==="THREE_CHAR_HEX"||n==="SIX_CHAR_HEX"){for(var v=t.hex.toString(16);v.length<6;)v="0"+v;return"#"+v}else{if(n==="CSS_RGB")return"rgb("+r+","+s+","+i+")";if(n==="CSS_RGBA")return"rgba("+r+","+s+","+i+","+a+")";if(n==="HEX")return"0x"+t.hex.toString(16);if(n==="RGB_ARRAY")return"["+r+","+s+","+i+"]";if(n==="RGBA_ARRAY")return"["+r+","+s+","+i+","+a+"]";if(n==="RGB_OBJ")return"{r:"+r+",g:"+s+",b:"+i+"}";if(n==="RGBA_OBJ")return"{r:"+r+",g:"+s+",b:"+i+",a:"+a+"}";if(n==="HSV_OBJ")return"{h:"+u+",s:"+d+",v:"+m+"}";if(n==="HSVA_OBJ")return"{h:"+u+",s:"+d+",v:"+m+",a:"+a+"}"}return"unknown format"}var ye=Array.prototype.forEach,qe=Array.prototype.slice,g={BREAK:{},extend:function(t){return this.each(qe.call(arguments,1),function(e){var n=this.isObject(e)?Object.keys(e):[];n.forEach((function(r){this.isUndefined(e[r])||(t[r]=e[r])}).bind(this))},this),t},defaults:function(t){return this.each(qe.call(arguments,1),function(e){var n=this.isObject(e)?Object.keys(e):[];n.forEach((function(r){this.isUndefined(t[r])&&(t[r]=e[r])}).bind(this))},this),t},compose:function(){var t=qe.call(arguments);return function(){for(var e=qe.call(arguments),n=t.length-1;n>=0;n--)e=[t[n].apply(this,e)];return e[0]}},each:function(t,e,n){if(t){if(ye&&t.forEach&&t.forEach===ye)t.forEach(e,n);else if(t.length===t.length+0){var r=void 0,s=void 0;for(r=0,s=t.length;r<s;r++)if(r in t&&e.call(n,t[r],r)===this.BREAK)return}else for(var i in t)if(e.call(n,t[i],i)===this.BREAK)return}},defer:function(t){setTimeout(t,0)},debounce:function(t,e,n){var r=void 0;return function(){var s=this,i=arguments;function a(){r=null,n||t.apply(s,i)}var u=n||!r;clearTimeout(r),r=setTimeout(a,e),u&&t.apply(s,i)}},toArray:function(t){return t.toArray?t.toArray():qe.call(t)},isUndefined:function(t){return t===void 0},isNull:function(t){return t===null},isNaN:function(t){function e(n){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return isNaN(t)}),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(t){return t===Object(t)},isNumber:function(t){return t===t+0},isString:function(t){return t===t+""},isBoolean:function(t){return t===!1||t===!0},isFunction:function(t){return t instanceof Function}},mr=[{litmus:g.isString,conversions:{THREE_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return e===null?!1:{space:"HEX",hex:parseInt("0x"+e[1].toString()+e[1].toString()+e[2].toString()+e[2].toString()+e[3].toString()+e[3].toString(),0)}},write:te},SIX_CHAR_HEX:{read:function(t){var e=t.match(/^#([A-F0-9]{6})$/i);return e===null?!1:{space:"HEX",hex:parseInt("0x"+e[1].toString(),0)}},write:te},CSS_RGB:{read:function(t){var e=t.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e===null?!1:{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3])}},write:te},CSS_RGBA:{read:function(t){var e=t.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return e===null?!1:{space:"RGB",r:parseFloat(e[1]),g:parseFloat(e[2]),b:parseFloat(e[3]),a:parseFloat(e[4])}},write:te}}},{litmus:g.isNumber,conversions:{HEX:{read:function(t){return{space:"HEX",hex:t,conversionName:"HEX"}},write:function(t){return t.hex}}}},{litmus:g.isArray,conversions:{RGB_ARRAY:{read:function(t){return t.length!==3?!1:{space:"RGB",r:t[0],g:t[1],b:t[2]}},write:function(t){return[t.r,t.g,t.b]}},RGBA_ARRAY:{read:function(t){return t.length!==4?!1:{space:"RGB",r:t[0],g:t[1],b:t[2],a:t[3]}},write:function(t){return[t.r,t.g,t.b,t.a]}}}},{litmus:g.isObject,conversions:{RGBA_OBJ:{read:function(t){return g.isNumber(t.r)&&g.isNumber(t.g)&&g.isNumber(t.b)&&g.isNumber(t.a)?{space:"RGB",r:t.r,g:t.g,b:t.b,a:t.a}:!1},write:function(t){return{r:t.r,g:t.g,b:t.b,a:t.a}}},RGB_OBJ:{read:function(t){return g.isNumber(t.r)&&g.isNumber(t.g)&&g.isNumber(t.b)?{space:"RGB",r:t.r,g:t.g,b:t.b}:!1},write:function(t){return{r:t.r,g:t.g,b:t.b}}},HSVA_OBJ:{read:function(t){return g.isNumber(t.h)&&g.isNumber(t.s)&&g.isNumber(t.v)&&g.isNumber(t.a)?{space:"HSV",h:t.h,s:t.s,v:t.v,a:t.a}:!1},write:function(t){return{h:t.h,s:t.s,v:t.v,a:t.a}}},HSV_OBJ:{read:function(t){return g.isNumber(t.h)&&g.isNumber(t.s)&&g.isNumber(t.v)?{space:"HSV",h:t.h,s:t.s,v:t.v}:!1},write:function(t){return{h:t.h,s:t.s,v:t.v}}}}}],Xe=void 0,rt=void 0,xt=function(){rt=!1;var t=arguments.length>1?g.toArray(arguments):arguments[0];return g.each(mr,function(e){if(e.litmus(t))return g.each(e.conversions,function(n,r){if(Xe=n.read(t),rt===!1&&Xe!==!1)return rt=Xe,Xe.conversionName=r,Xe.conversion=n,g.BREAK}),g.BREAK}),rt},Qt=void 0,st={hsv_to_rgb:function(t,e,n){var r=Math.floor(t/60)%6,s=t/60-Math.floor(t/60),i=n*(1-e),a=n*(1-s*e),u=n*(1-(1-s)*e),d=[[n,u,i],[a,n,i],[i,n,u],[i,a,n],[u,i,n],[n,i,a]][r];return{r:d[0]*255,g:d[1]*255,b:d[2]*255}},rgb_to_hsv:function(t,e,n){var r=Math.min(t,e,n),s=Math.max(t,e,n),i=s-r,a=void 0,u=void 0;if(s!==0)u=i/s;else return{h:NaN,s:0,v:0};return t===s?a=(e-n)/i:e===s?a=2+(n-t)/i:a=4+(t-e)/i,a/=6,a<0&&(a+=1),{h:a*360,s:u,v:s/255}},rgb_to_hex:function(t,e,n){var r=this.hex_with_component(0,2,t);return r=this.hex_with_component(r,1,e),r=this.hex_with_component(r,0,n),r},component_from_hex:function(t,e){return t>>e*8&255},hex_with_component:function(t,e,n){return n<<(Qt=e*8)|t&~(255<<Qt)}},gr=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},oe=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},ue=function(){function t(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),ve=function t(e,n,r){e===null&&(e=Function.prototype);var s=Object.getOwnPropertyDescriptor(e,n);if(s===void 0){var i=Object.getPrototypeOf(e);return i===null?void 0:t(i,n,r)}else{if("value"in s)return s.value;var a=s.get;return a===void 0?void 0:a.call(r)}},be=function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},xe=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t},Z=function(){function t(){if(oe(this,t),this.__state=xt.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return ue(t,[{key:"toString",value:function(){return te(this)}},{key:"toHexString",value:function(){return te(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t}();function wt(t,e,n){Object.defineProperty(t,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(Z.recalculateRGB(this,e,n),this.__state[e])},set:function(r){this.__state.space!=="RGB"&&(Z.recalculateRGB(this,e,n),this.__state.space="RGB"),this.__state[e]=r}})}function kt(t,e){Object.defineProperty(t,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(Z.recalculateHSV(this),this.__state[e])},set:function(n){this.__state.space!=="HSV"&&(Z.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=n}})}Z.recalculateRGB=function(t,e,n){if(t.__state.space==="HEX")t.__state[e]=st.component_from_hex(t.__state.hex,n);else if(t.__state.space==="HSV")g.extend(t.__state,st.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v));else throw new Error("Corrupted color state")},Z.recalculateHSV=function(t){var e=st.rgb_to_hsv(t.r,t.g,t.b);g.extend(t.__state,{s:e.s,v:e.v}),g.isNaN(e.h)?g.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h},Z.COMPONENTS=["r","g","b","h","s","v","hex","a"],wt(Z.prototype,"r",2),wt(Z.prototype,"g",1),wt(Z.prototype,"b",0),kt(Z.prototype,"h"),kt(Z.prototype,"s"),kt(Z.prototype,"v"),Object.defineProperty(Z.prototype,"a",{get:function(){return this.__state.a},set:function(t){this.__state.a=t}}),Object.defineProperty(Z.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=st.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(t){this.__state.space="HEX",this.__state.hex=t}});var Se=function(){function t(e,n){oe(this,t),this.initialValue=e[n],this.domElement=document.createElement("div"),this.object=e,this.property=n,this.__onChange=void 0,this.__onFinishChange=void 0}return ue(t,[{key:"onChange",value:function(e){return this.__onChange=e,this}},{key:"onFinishChange",value:function(e){return this.__onFinishChange=e,this}},{key:"setValue",value:function(e){return this.object[this.property]=e,this.__onChange&&this.__onChange.call(this,e),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t}(),yr={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},en={};g.each(yr,function(t,e){g.each(t,function(n){en[n]=e})});var vr=/(\d+(\.\d+)?)px/;function le(t){if(t==="0"||g.isUndefined(t))return 0;var e=t.match(vr);return g.isNull(e)?0:parseFloat(e[1])}var _={makeSelectable:function(t,e){t===void 0||t.style===void 0||(t.onselectstart=e?function(){return!1}:function(){},t.style.MozUserSelect=e?"auto":"none",t.style.KhtmlUserSelect=e?"auto":"none",t.unselectable=e?"on":"off")},makeFullscreen:function(t,e,n){var r=n,s=e;g.isUndefined(s)&&(s=!0),g.isUndefined(r)&&(r=!0),t.style.position="absolute",s&&(t.style.left=0,t.style.right=0),r&&(t.style.top=0,t.style.bottom=0)},fakeEvent:function(t,e,n,r){var s=n||{},i=en[e];if(!i)throw new Error("Event type "+e+" not supported.");var a=document.createEvent(i);switch(i){case"MouseEvents":{var u=s.x||s.clientX||0,d=s.y||s.clientY||0;a.initMouseEvent(e,s.bubbles||!1,s.cancelable||!0,window,s.clickCount||1,0,0,u,d,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var m=a.initKeyboardEvent||a.initKeyEvent;g.defaults(s,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),m(e,s.bubbles||!1,s.cancelable,window,s.ctrlKey,s.altKey,s.shiftKey,s.metaKey,s.keyCode,s.charCode);break}default:{a.initEvent(e,s.bubbles||!1,s.cancelable||!0);break}}g.defaults(a,r),t.dispatchEvent(a)},bind:function(t,e,n,r){var s=r||!1;return t.addEventListener?t.addEventListener(e,n,s):t.attachEvent&&t.attachEvent("on"+e,n),_},unbind:function(t,e,n,r){var s=r||!1;return t.removeEventListener?t.removeEventListener(e,n,s):t.detachEvent&&t.detachEvent("on"+e,n),_},addClass:function(t,e){if(t.className===void 0)t.className=e;else if(t.className!==e){var n=t.className.split(/ +/);n.indexOf(e)===-1&&(n.push(e),t.className=n.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return _},removeClass:function(t,e){if(e)if(t.className===e)t.removeAttribute("class");else{var n=t.className.split(/ +/),r=n.indexOf(e);r!==-1&&(n.splice(r,1),t.className=n.join(" "))}else t.className=void 0;return _},hasClass:function(t,e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(t.className)||!1},getWidth:function(t){var e=getComputedStyle(t);return le(e["border-left-width"])+le(e["border-right-width"])+le(e["padding-left"])+le(e["padding-right"])+le(e.width)},getHeight:function(t){var e=getComputedStyle(t);return le(e["border-top-width"])+le(e["border-bottom-width"])+le(e["padding-top"])+le(e["padding-bottom"])+le(e.height)},getOffset:function(t){var e=t,n={left:0,top:0};if(e.offsetParent)do n.left+=e.offsetLeft,n.top+=e.offsetTop,e=e.offsetParent;while(e);return n},isActive:function(t){return t===document.activeElement&&(t.type||t.href)}},tn=function(t){be(e,t);function e(n,r){oe(this,e);var s=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),i=s;s.__prev=s.getValue(),s.__checkbox=document.createElement("input"),s.__checkbox.setAttribute("type","checkbox");function a(){i.setValue(!i.__prev)}return _.bind(s.__checkbox,"change",a,!1),s.domElement.appendChild(s.__checkbox),s.updateDisplay(),s}return ue(e,[{key:"setValue",value:function(n){var r=ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,n);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),r}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Se),br=function(t){be(e,t);function e(n,r,s){oe(this,e);var i=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),a=s,u=i;if(i.__select=document.createElement("select"),g.isArray(a)){var d={};g.each(a,function(m){d[m]=m}),a=d}return g.each(a,function(m,v){var h=document.createElement("option");h.innerHTML=v,h.setAttribute("value",m),u.__select.appendChild(h)}),i.updateDisplay(),_.bind(i.__select,"change",function(){var m=this.options[this.selectedIndex].value;u.setValue(m)}),i.domElement.appendChild(i.__select),i}return ue(e,[{key:"setValue",value:function(n){var r=ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,n);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),r}},{key:"updateDisplay",value:function(){return _.isActive(this.__select)?this:(this.__select.value=this.getValue(),ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(Se),xr=function(t){be(e,t);function e(n,r){oe(this,e);var s=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),i=s;function a(){i.setValue(i.__input.value)}function u(){i.__onFinishChange&&i.__onFinishChange.call(i,i.getValue())}return s.__input=document.createElement("input"),s.__input.setAttribute("type","text"),_.bind(s.__input,"keyup",a),_.bind(s.__input,"change",a),_.bind(s.__input,"blur",u),_.bind(s.__input,"keydown",function(d){d.keyCode===13&&this.blur()}),s.updateDisplay(),s.domElement.appendChild(s.__input),s}return ue(e,[{key:"updateDisplay",value:function(){return _.isActive(this.__input)||(this.__input.value=this.getValue()),ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Se);function nn(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var rn=function(t){be(e,t);function e(n,r,s){oe(this,e);var i=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),a=s||{};return i.__min=a.min,i.__max=a.max,i.__step=a.step,g.isUndefined(i.__step)?i.initialValue===0?i.__impliedStep=1:i.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(i.initialValue))/Math.LN10))/10:i.__impliedStep=i.__step,i.__precision=nn(i.__impliedStep),i}return ue(e,[{key:"setValue",value:function(n){var r=n;return this.__min!==void 0&&r<this.__min?r=this.__min:this.__max!==void 0&&r>this.__max&&(r=this.__max),this.__step!==void 0&&r%this.__step!==0&&(r=Math.round(r/this.__step)*this.__step),ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,r)}},{key:"min",value:function(n){return this.__min=n,this}},{key:"max",value:function(n){return this.__max=n,this}},{key:"step",value:function(n){return this.__step=n,this.__impliedStep=n,this.__precision=nn(n),this}}]),e}(Se);function wr(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var it=function(t){be(e,t);function e(n,r,s){oe(this,e);var i=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r,s));i.__truncationSuspended=!1;var a=i,u=void 0;function d(){var S=parseFloat(a.__input.value);g.isNaN(S)||a.setValue(S)}function m(){a.__onFinishChange&&a.__onFinishChange.call(a,a.getValue())}function v(){m()}function h(S){var b=u-S.clientY;a.setValue(a.getValue()+b*a.__impliedStep),u=S.clientY}function p(){_.unbind(window,"mousemove",h),_.unbind(window,"mouseup",p),m()}function y(S){_.bind(window,"mousemove",h),_.bind(window,"mouseup",p),u=S.clientY}return i.__input=document.createElement("input"),i.__input.setAttribute("type","text"),_.bind(i.__input,"change",d),_.bind(i.__input,"blur",v),_.bind(i.__input,"mousedown",y),_.bind(i.__input,"keydown",function(S){S.keyCode===13&&(a.__truncationSuspended=!0,this.blur(),a.__truncationSuspended=!1,m())}),i.updateDisplay(),i.domElement.appendChild(i.__input),i}return ue(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():wr(this.getValue(),this.__precision),ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(rn);function sn(t,e,n,r,s){return r+(s-r)*((t-e)/(n-e))}var Et=function(t){be(e,t);function e(n,r,s,i,a){oe(this,e);var u=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r,{min:s,max:i,step:a})),d=u;u.__background=document.createElement("div"),u.__foreground=document.createElement("div"),_.bind(u.__background,"mousedown",m),_.bind(u.__background,"touchstart",p),_.addClass(u.__background,"slider"),_.addClass(u.__foreground,"slider-fg");function m(b){document.activeElement.blur(),_.bind(window,"mousemove",v),_.bind(window,"mouseup",h),v(b)}function v(b){b.preventDefault();var F=d.__background.getBoundingClientRect();return d.setValue(sn(b.clientX,F.left,F.right,d.__min,d.__max)),!1}function h(){_.unbind(window,"mousemove",v),_.unbind(window,"mouseup",h),d.__onFinishChange&&d.__onFinishChange.call(d,d.getValue())}function p(b){b.touches.length===1&&(_.bind(window,"touchmove",y),_.bind(window,"touchend",S),y(b))}function y(b){var F=b.touches[0].clientX,I=d.__background.getBoundingClientRect();d.setValue(sn(F,I.left,I.right,d.__min,d.__max))}function S(){_.unbind(window,"touchmove",y),_.unbind(window,"touchend",S),d.__onFinishChange&&d.__onFinishChange.call(d,d.getValue())}return u.updateDisplay(),u.__background.appendChild(u.__foreground),u.domElement.appendChild(u.__background),u}return ue(e,[{key:"updateDisplay",value:function(){var n=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=n*100+"%",ve(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(rn),an=function(t){be(e,t);function e(n,r,s){oe(this,e);var i=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r)),a=i;return i.__button=document.createElement("div"),i.__button.innerHTML=s===void 0?"Fire":s,_.bind(i.__button,"click",function(u){return u.preventDefault(),a.fire(),!1}),_.addClass(i.__button,"button"),i.domElement.appendChild(i.__button),i}return ue(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(Se),St=function(t){be(e,t);function e(n,r){oe(this,e);var s=xe(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,r));s.__color=new Z(s.getValue()),s.__temp=new Z(0);var i=s;s.domElement=document.createElement("div"),_.makeSelectable(s.domElement,!1),s.__selector=document.createElement("div"),s.__selector.className="selector",s.__saturation_field=document.createElement("div"),s.__saturation_field.className="saturation-field",s.__field_knob=document.createElement("div"),s.__field_knob.className="field-knob",s.__field_knob_border="2px solid ",s.__hue_knob=document.createElement("div"),s.__hue_knob.className="hue-knob",s.__hue_field=document.createElement("div"),s.__hue_field.className="hue-field",s.__input=document.createElement("input"),s.__input.type="text",s.__input_textShadow="0 1px 1px ",_.bind(s.__input,"keydown",function(b){b.keyCode===13&&h.call(this)}),_.bind(s.__input,"blur",h),_.bind(s.__selector,"mousedown",function(){_.addClass(this,"drag").bind(window,"mouseup",function(){_.removeClass(i.__selector,"drag")})}),_.bind(s.__selector,"touchstart",function(){_.addClass(this,"drag").bind(window,"touchend",function(){_.removeClass(i.__selector,"drag")})});var a=document.createElement("div");g.extend(s.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),g.extend(s.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:s.__field_knob_border+(s.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),g.extend(s.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),g.extend(s.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),g.extend(a.style,{width:"100%",height:"100%",background:"none"}),on(a,"top","rgba(0,0,0,0)","#000"),g.extend(s.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),Er(s.__hue_field),g.extend(s.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:s.__input_textShadow+"rgba(0,0,0,0.7)"}),_.bind(s.__saturation_field,"mousedown",u),_.bind(s.__saturation_field,"touchstart",u),_.bind(s.__field_knob,"mousedown",u),_.bind(s.__field_knob,"touchstart",u),_.bind(s.__hue_field,"mousedown",d),_.bind(s.__hue_field,"touchstart",d);function u(b){y(b),_.bind(window,"mousemove",y),_.bind(window,"touchmove",y),_.bind(window,"mouseup",m),_.bind(window,"touchend",m)}function d(b){S(b),_.bind(window,"mousemove",S),_.bind(window,"touchmove",S),_.bind(window,"mouseup",v),_.bind(window,"touchend",v)}function m(){_.unbind(window,"mousemove",y),_.unbind(window,"touchmove",y),_.unbind(window,"mouseup",m),_.unbind(window,"touchend",m),p()}function v(){_.unbind(window,"mousemove",S),_.unbind(window,"touchmove",S),_.unbind(window,"mouseup",v),_.unbind(window,"touchend",v),p()}function h(){var b=xt(this.value);b!==!1?(i.__color.__state=b,i.setValue(i.__color.toOriginal())):this.value=i.__color.toString()}function p(){i.__onFinishChange&&i.__onFinishChange.call(i,i.__color.toOriginal())}s.__saturation_field.appendChild(a),s.__selector.appendChild(s.__field_knob),s.__selector.appendChild(s.__saturation_field),s.__selector.appendChild(s.__hue_field),s.__hue_field.appendChild(s.__hue_knob),s.domElement.appendChild(s.__input),s.domElement.appendChild(s.__selector),s.updateDisplay();function y(b){b.type.indexOf("touch")===-1&&b.preventDefault();var F=i.__saturation_field.getBoundingClientRect(),I=b.touches&&b.touches[0]||b,Y=I.clientX,R=I.clientY,U=(Y-F.left)/(F.right-F.left),O=1-(R-F.top)/(F.bottom-F.top);return O>1?O=1:O<0&&(O=0),U>1?U=1:U<0&&(U=0),i.__color.v=O,i.__color.s=U,i.setValue(i.__color.toOriginal()),!1}function S(b){b.type.indexOf("touch")===-1&&b.preventDefault();var F=i.__hue_field.getBoundingClientRect(),I=b.touches&&b.touches[0]||b,Y=I.clientY,R=1-(Y-F.top)/(F.bottom-F.top);return R>1?R=1:R<0&&(R=0),i.__color.h=R*360,i.setValue(i.__color.toOriginal()),!1}return s}return ue(e,[{key:"updateDisplay",value:function(){var n=xt(this.getValue());if(n!==!1){var r=!1;g.each(Z.COMPONENTS,function(a){if(!g.isUndefined(n[a])&&!g.isUndefined(this.__color.__state[a])&&n[a]!==this.__color.__state[a])return r=!0,{}},this),r&&g.extend(this.__color.__state,n)}g.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var s=this.__color.v<.5||this.__color.s>.5?255:0,i=255-s;g.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+s+","+s+","+s+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,on(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),g.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+s+","+s+","+s+")",textShadow:this.__input_textShadow+"rgba("+i+","+i+","+i+",.7)"})}}]),e}(Se),kr=["-moz-","-o-","-webkit-","-ms-",""];function on(t,e,n,r){t.style.background="",g.each(kr,function(s){t.style.cssText+="background: "+s+"linear-gradient("+e+", "+n+" 0%, "+r+" 100%); "})}function Er(t){t.style.background="",t.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",t.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var Sr={load:function(t,e){var n=e||document,r=n.createElement("link");r.type="text/css",r.rel="stylesheet",r.href=t,n.getElementsByTagName("head")[0].appendChild(r)},inject:function(t,e){var n=e||document,r=document.createElement("style");r.type="text/css",r.innerHTML=t;var s=n.getElementsByTagName("head")[0];try{s.appendChild(r)}catch{}}},Ar=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,Mr=function(t,e){var n=t[e];return g.isArray(arguments[2])||g.isObject(arguments[2])?new br(t,e,arguments[2]):g.isNumber(n)?g.isNumber(arguments[2])&&g.isNumber(arguments[3])?g.isNumber(arguments[4])?new Et(t,e,arguments[2],arguments[3],arguments[4]):new Et(t,e,arguments[2],arguments[3]):g.isNumber(arguments[4])?new it(t,e,{min:arguments[2],max:arguments[3],step:arguments[4]}):new it(t,e,{min:arguments[2],max:arguments[3]}):g.isString(n)?new xr(t,e):g.isFunction(n)?new an(t,e,""):g.isBoolean(n)?new tn(t,e):null};function Tr(t){setTimeout(t,1e3/60)}var Ir=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||Tr,Cr=function(){function t(){oe(this,t),this.backgroundElement=document.createElement("div"),g.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),_.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),g.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;_.bind(this.backgroundElement,"click",function(){e.hide()})}return ue(t,[{key:"show",value:function(){var e=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),g.defer(function(){e.backgroundElement.style.opacity=1,e.domElement.style.opacity=1,e.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var e=this,n=function r(){e.domElement.style.display="none",e.backgroundElement.style.display="none",_.unbind(e.domElement,"webkitTransitionEnd",r),_.unbind(e.domElement,"transitionend",r),_.unbind(e.domElement,"oTransitionEnd",r)};_.bind(this.domElement,"webkitTransitionEnd",n),_.bind(this.domElement,"transitionend",n),_.bind(this.domElement,"oTransitionEnd",n),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-_.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-_.getHeight(this.domElement)/2+"px"}}]),t}(),Nr=Ee(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);Sr.inject(Nr);var un="dg",cn=72,ln=20,Ye="Default",Ke=function(){try{return!!window.localStorage}catch{return!1}}(),We=void 0,hn=!0,De=void 0,At=!1,dn=[],H=function t(e){var n=this,r=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),_.addClass(this.domElement,un),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],r=g.defaults(r,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),r=g.defaults(r,{resizable:r.autoPlace,hideable:r.autoPlace}),g.isUndefined(r.load)?r.load={preset:Ye}:r.preset&&(r.load.preset=r.preset),g.isUndefined(r.parent)&&r.hideable&&dn.push(this),r.resizable=g.isUndefined(r.parent)&&r.resizable,r.autoPlace&&g.isUndefined(r.scrollable)&&(r.scrollable=!0);var s=Ke&&localStorage.getItem(Le(this,"isLocal"))==="true",i=void 0,a=void 0;if(Object.defineProperties(this,{parent:{get:function(){return r.parent}},scrollable:{get:function(){return r.scrollable}},autoPlace:{get:function(){return r.autoPlace}},closeOnTop:{get:function(){return r.closeOnTop}},preset:{get:function(){return n.parent?n.getRoot().preset:r.load.preset},set:function(h){n.parent?n.getRoot().preset=h:r.load.preset=h,Dr(this),n.revert()}},width:{get:function(){return r.width},set:function(h){r.width=h,Ct(n,h)}},name:{get:function(){return r.name},set:function(h){r.name=h,a&&(a.innerHTML=r.name)}},closed:{get:function(){return r.closed},set:function(h){r.closed=h,r.closed?_.addClass(n.__ul,t.CLASS_CLOSED):_.removeClass(n.__ul,t.CLASS_CLOSED),this.onResize(),n.__closeButton&&(n.__closeButton.innerHTML=h?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return r.load}},useLocalStorage:{get:function(){return s},set:function(h){Ke&&(s=h,h?_.bind(window,"unload",i):_.unbind(window,"unload",i),localStorage.setItem(Le(n,"isLocal"),h))}}}),g.isUndefined(r.parent)){if(this.closed=r.closed||!1,_.addClass(this.domElement,t.CLASS_MAIN),_.makeSelectable(this.domElement,!1),Ke&&s){n.useLocalStorage=!0;var u=localStorage.getItem(Le(this,"gui"));u&&(r.load=JSON.parse(u))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,_.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),r.closeOnTop?(_.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(_.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),_.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{r.closed===void 0&&(r.closed=!0);var d=document.createTextNode(r.name);_.addClass(d,"controller-name"),a=Mt(n,d);var m=function(h){return h.preventDefault(),n.closed=!n.closed,!1};_.addClass(this.__ul,t.CLASS_CLOSED),_.addClass(a,"title"),_.bind(a,"click",m),r.closed||(this.closed=!1)}r.autoPlace&&(g.isUndefined(r.parent)&&(hn&&(De=document.createElement("div"),_.addClass(De,un),_.addClass(De,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(De),hn=!1),De.appendChild(this.domElement),_.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||Ct(n,r.width)),this.__resizeHandler=function(){n.onResizeDebounced()},_.bind(window,"resize",this.__resizeHandler),_.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),_.bind(this.__ul,"transitionend",this.__resizeHandler),_.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),r.resizable&&Br(this),i=function(){Ke&&localStorage.getItem(Le(n,"isLocal"))==="true"&&localStorage.setItem(Le(n,"gui"),JSON.stringify(n.getSaveObject()))},this.saveToLocalStorageIfPossible=i;function v(){var h=n.getRoot();h.width+=1,g.defer(function(){h.width-=1})}r.parent||v()};H.toggleHide=function(){At=!At,g.each(dn,function(t){t.domElement.style.display=At?"none":""})},H.CLASS_AUTO_PLACE="a",H.CLASS_AUTO_PLACE_CONTAINER="ac",H.CLASS_MAIN="main",H.CLASS_CONTROLLER_ROW="cr",H.CLASS_TOO_TALL="taller-than-window",H.CLASS_CLOSED="closed",H.CLASS_CLOSE_BUTTON="close-button",H.CLASS_CLOSE_TOP="close-top",H.CLASS_CLOSE_BOTTOM="close-bottom",H.CLASS_DRAG="drag",H.DEFAULT_WIDTH=245,H.TEXT_CLOSED="Close Controls",H.TEXT_OPEN="Open Controls",H._keydownHandler=function(t){document.activeElement.type!=="text"&&(t.which===cn||t.keyCode===cn)&&H.toggleHide()},_.bind(window,"keydown",H._keydownHandler,!1),g.extend(H.prototype,{add:function(t,e){return Ze(this,t,e,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(t,e){return Ze(this,t,e,{color:!0})},remove:function(t){this.__ul.removeChild(t.__li),this.__controllers.splice(this.__controllers.indexOf(t),1);var e=this;g.defer(function(){e.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&De.removeChild(this.domElement);var t=this;g.each(this.__folders,function(e){t.removeFolder(e)}),_.unbind(window,"keydown",H._keydownHandler,!1),_n(this)},addFolder:function(t){if(this.__folders[t]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+t+'"');var e={name:t,parent:this};e.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[t]&&(e.closed=this.load.folders[t].closed,e.load=this.load.folders[t]);var n=new H(e);this.__folders[t]=n;var r=Mt(this,n.domElement);return _.addClass(r,"folder"),n},removeFolder:function(t){this.__ul.removeChild(t.domElement.parentElement),delete this.__folders[t.name],this.load&&this.load.folders&&this.load.folders[t.name]&&delete this.load.folders[t.name],_n(t);var e=this;g.each(t.__folders,function(n){t.removeFolder(n)}),g.defer(function(){e.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var t=this.getRoot();if(t.scrollable){var e=_.getOffset(t.__ul).top,n=0;g.each(t.__ul.childNodes,function(r){t.autoPlace&&r===t.__save_row||(n+=_.getHeight(r))}),window.innerHeight-e-ln<n?(_.addClass(t.domElement,H.CLASS_TOO_TALL),t.__ul.style.height=window.innerHeight-e-ln+"px"):(_.removeClass(t.domElement,H.CLASS_TOO_TALL),t.__ul.style.height="auto")}t.__resize_handle&&g.defer(function(){t.__resize_handle.style.height=t.__ul.offsetHeight+"px"}),t.__closeButton&&(t.__closeButton.style.width=t.width+"px")},onResizeDebounced:g.debounce(function(){this.onResize()},50),remember:function(){if(g.isUndefined(We)&&(We=new Cr,We.domElement.innerHTML=Ar),this.parent)throw new Error("You can only call remember on a top level GUI.");var t=this;g.each(Array.prototype.slice.call(arguments),function(e){t.__rememberedObjects.length===0&&Or(t),t.__rememberedObjects.indexOf(e)===-1&&t.__rememberedObjects.push(e)}),this.autoPlace&&Ct(this,this.width)},getRoot:function(){for(var t=this;t.parent;)t=t.parent;return t},getSaveObject:function(){var t=this.load;return t.closed=this.closed,this.__rememberedObjects.length>0&&(t.preset=this.preset,t.remembered||(t.remembered={}),t.remembered[this.preset]=at(this)),t.folders={},g.each(this.__folders,function(e,n){t.folders[n]=e.getSaveObject()}),t},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=at(this),Tt(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(t){this.load.remembered||(this.load.remembered={},this.load.remembered[Ye]=at(this,!0)),this.load.remembered[t]=at(this),this.preset=t,It(this,t,!0),this.saveToLocalStorageIfPossible()},revert:function(t){g.each(this.__controllers,function(e){this.getRoot().load.remembered?pn(t||this.getRoot(),e):e.setValue(e.initialValue),e.__onFinishChange&&e.__onFinishChange.call(e,e.getValue())},this),g.each(this.__folders,function(e){e.revert(e)}),t||Tt(this.getRoot(),!1)},listen:function(t){var e=this.__listening.length===0;this.__listening.push(t),e&&mn(this.__listening)},updateDisplay:function(){g.each(this.__controllers,function(t){t.updateDisplay()}),g.each(this.__folders,function(t){t.updateDisplay()})}});function Mt(t,e,n){var r=document.createElement("li");return e&&r.appendChild(e),n?t.__ul.insertBefore(r,n):t.__ul.appendChild(r),t.onResize(),r}function _n(t){_.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&_.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function Tt(t,e){var n=t.__preset_select[t.__preset_select.selectedIndex];e?n.innerHTML=n.value+"*":n.innerHTML=n.value}function Rr(t,e,n){if(n.__li=e,n.__gui=t,g.extend(n,{options:function(i){if(arguments.length>1){var a=n.__li.nextElementSibling;return n.remove(),Ze(t,n.object,n.property,{before:a,factoryArgs:[g.toArray(arguments)]})}if(g.isArray(i)||g.isObject(i)){var u=n.__li.nextElementSibling;return n.remove(),Ze(t,n.object,n.property,{before:u,factoryArgs:[i]})}},name:function(i){return n.__li.firstElementChild.firstElementChild.innerHTML=i,n},listen:function(){return n.__gui.listen(n),n},remove:function(){return n.__gui.remove(n),n}}),n instanceof Et){var r=new it(n.object,n.property,{min:n.__min,max:n.__max,step:n.__step});g.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(i){var a=n[i],u=r[i];n[i]=r[i]=function(){var d=Array.prototype.slice.call(arguments);return u.apply(r,d),a.apply(n,d)}}),_.addClass(e,"has-slider"),n.domElement.insertBefore(r.domElement,n.domElement.firstElementChild)}else if(n instanceof it){var s=function(i){if(g.isNumber(n.__min)&&g.isNumber(n.__max)){var a=n.__li.firstElementChild.firstElementChild.innerHTML,u=n.__gui.__listening.indexOf(n)>-1;n.remove();var d=Ze(t,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[n.__min,n.__max,n.__step]});return d.name(a),u&&d.listen(),d}return i};n.min=g.compose(s,n.min),n.max=g.compose(s,n.max)}else n instanceof tn?(_.bind(e,"click",function(){_.fakeEvent(n.__checkbox,"click")}),_.bind(n.__checkbox,"click",function(i){i.stopPropagation()})):n instanceof an?(_.bind(e,"click",function(){_.fakeEvent(n.__button,"click")}),_.bind(e,"mouseover",function(){_.addClass(n.__button,"hover")}),_.bind(e,"mouseout",function(){_.removeClass(n.__button,"hover")})):n instanceof St&&(_.addClass(e,"color"),n.updateDisplay=g.compose(function(i){return e.style.borderLeftColor=n.__color.toString(),i},n.updateDisplay),n.updateDisplay());n.setValue=g.compose(function(i){return t.getRoot().__preset_select&&n.isModified()&&Tt(t.getRoot(),!0),i},n.setValue)}function pn(t,e){var n=t.getRoot(),r=n.__rememberedObjects.indexOf(e.object);if(r!==-1){var s=n.__rememberedObjectIndecesToControllers[r];if(s===void 0&&(s={},n.__rememberedObjectIndecesToControllers[r]=s),s[e.property]=e,n.load&&n.load.remembered){var i=n.load.remembered,a=void 0;if(i[t.preset])a=i[t.preset];else if(i[Ye])a=i[Ye];else return;if(a[r]&&a[r][e.property]!==void 0){var u=a[r][e.property];e.initialValue=u,e.setValue(u)}}}}function Ze(t,e,n,r){if(e[n]===void 0)throw new Error('Object "'+e+'" has no property "'+n+'"');var s=void 0;if(r.color)s=new St(e,n);else{var i=[e,n].concat(r.factoryArgs);s=Mr.apply(t,i)}r.before instanceof Se&&(r.before=r.before.__li),pn(t,s),_.addClass(s.domElement,"c");var a=document.createElement("span");_.addClass(a,"property-name"),a.innerHTML=s.property;var u=document.createElement("div");u.appendChild(a),u.appendChild(s.domElement);var d=Mt(t,u,r.before);return _.addClass(d,H.CLASS_CONTROLLER_ROW),s instanceof St?_.addClass(d,"color"):_.addClass(d,gr(s.getValue())),Rr(t,d,s),t.__controllers.push(s),s}function Le(t,e){return document.location.href+"."+e}function It(t,e,n){var r=document.createElement("option");r.innerHTML=e,r.value=e,t.__preset_select.appendChild(r),n&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function fn(t,e){e.style.display=t.useLocalStorage?"block":"none"}function Or(t){var e=t.__save_row=document.createElement("li");_.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),_.addClass(e,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",_.addClass(n,"button gears");var r=document.createElement("span");r.innerHTML="Save",_.addClass(r,"button"),_.addClass(r,"save");var s=document.createElement("span");s.innerHTML="New",_.addClass(s,"button"),_.addClass(s,"save-as");var i=document.createElement("span");i.innerHTML="Revert",_.addClass(i,"button"),_.addClass(i,"revert");var a=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?g.each(t.load.remembered,function(h,p){It(t,p,p===t.preset)}):It(t,Ye,!1),_.bind(a,"change",function(){for(var h=0;h<t.__preset_select.length;h++)t.__preset_select[h].innerHTML=t.__preset_select[h].value;t.preset=this.value}),e.appendChild(a),e.appendChild(n),e.appendChild(r),e.appendChild(s),e.appendChild(i),Ke){var u=document.getElementById("dg-local-explain"),d=document.getElementById("dg-local-storage"),m=document.getElementById("dg-save-locally");m.style.display="block",localStorage.getItem(Le(t,"isLocal"))==="true"&&d.setAttribute("checked","checked"),fn(t,u),_.bind(d,"change",function(){t.useLocalStorage=!t.useLocalStorage,fn(t,u)})}var v=document.getElementById("dg-new-constructor");_.bind(v,"keydown",function(h){h.metaKey&&(h.which===67||h.keyCode===67)&&We.hide()}),_.bind(n,"click",function(){v.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),We.show(),v.focus(),v.select()}),_.bind(r,"click",function(){t.save()}),_.bind(s,"click",function(){var h=prompt("Enter a new preset name.");h&&t.saveAs(h)}),_.bind(i,"click",function(){t.revert()})}function Br(t){var e=void 0;t.__resize_handle=document.createElement("div"),g.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function n(i){return i.preventDefault(),t.width+=e-i.clientX,t.onResize(),e=i.clientX,!1}function r(){_.removeClass(t.__closeButton,H.CLASS_DRAG),_.unbind(window,"mousemove",n),_.unbind(window,"mouseup",r)}function s(i){return i.preventDefault(),e=i.clientX,_.addClass(t.__closeButton,H.CLASS_DRAG),_.bind(window,"mousemove",n),_.bind(window,"mouseup",r),!1}_.bind(t.__resize_handle,"mousedown",s),_.bind(t.__closeButton,"mousedown",s),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function Ct(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function at(t,e){var n={};return g.each(t.__rememberedObjects,function(r,s){var i={},a=t.__rememberedObjectIndecesToControllers[s];g.each(a,function(u,d){i[d]=e?u.initialValue:u.getValue()}),n[s]=i}),n}function Dr(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}function mn(t){t.length!==0&&Ir.call(window,function(){mn(t)}),g.each(t,function(e){e.updateDisplay()})}var Lr=H,gn=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Nt(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var yn={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(gn,function(){var n=1e3,r=6e4,s=36e5,i="millisecond",a="second",u="minute",d="hour",m="day",v="week",h="month",p="quarter",y="year",S="date",b="Invalid Date",F=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,I=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Y={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(M){var w=["th","st","nd","rd"],x=M%100;return"["+M+(w[(x-20)%10]||w[x]||w[0])+"]"}},R=function(M,w,x){var T=String(M);return!T||T.length>=w?M:""+Array(w+1-T.length).join(x)+M},U={s:R,z:function(M){var w=-M.utcOffset(),x=Math.abs(w),T=Math.floor(x/60),k=x%60;return(w<=0?"+":"-")+R(T,2,"0")+":"+R(k,2,"0")},m:function M(w,x){if(w.date()<x.date())return-M(x,w);var T=12*(x.year()-w.year())+(x.month()-w.month()),k=w.clone().add(T,h),D=x-k<0,L=w.clone().add(T+(D?-1:1),h);return+(-(T+(x-k)/(D?k-L:L-k))||0)},a:function(M){return M<0?Math.ceil(M)||0:Math.floor(M)},p:function(M){return{M:h,y,w:v,d:m,D:S,h:d,m:u,s:a,ms:i,Q:p}[M]||String(M||"").toLowerCase().replace(/s$/,"")},u:function(M){return M===void 0}},O="en",A={};A[O]=Y;var C="$isDayjsObject",E=function(M){return M instanceof K||!(!M||!M[C])},z=function M(w,x,T){var k;if(!w)return O;if(typeof w=="string"){var D=w.toLowerCase();A[D]&&(k=D),x&&(A[D]=x,k=D);var L=w.split("-");if(!k&&L.length>1)return M(L[0])}else{var j=w.name;A[j]=w,k=j}return!T&&k&&(O=k),k||!T&&O},B=function(M,w){if(E(M))return M.clone();var x=typeof w=="object"?w:{};return x.date=M,x.args=arguments,new K(x)},N=U;N.l=z,N.i=E,N.w=function(M,w){return B(M,{locale:w.$L,utc:w.$u,x:w.$x,$offset:w.$offset})};var K=function(){function M(x){this.$L=z(x.locale,null,!0),this.parse(x),this.$x=this.$x||x.x||{},this[C]=!0}var w=M.prototype;return w.parse=function(x){this.$d=function(T){var k=T.date,D=T.utc;if(k===null)return new Date(NaN);if(N.u(k))return new Date;if(k instanceof Date)return new Date(k);if(typeof k=="string"&&!/Z$/i.test(k)){var L=k.match(F);if(L){var j=L[2]-1||0,W=(L[7]||"0").substring(0,3);return D?new Date(Date.UTC(L[1],j,L[3]||1,L[4]||0,L[5]||0,L[6]||0,W)):new Date(L[1],j,L[3]||1,L[4]||0,L[5]||0,L[6]||0,W)}}return new Date(k)}(x),this.init()},w.init=function(){var x=this.$d;this.$y=x.getFullYear(),this.$M=x.getMonth(),this.$D=x.getDate(),this.$W=x.getDay(),this.$H=x.getHours(),this.$m=x.getMinutes(),this.$s=x.getSeconds(),this.$ms=x.getMilliseconds()},w.$utils=function(){return N},w.isValid=function(){return this.$d.toString()!==b},w.isSame=function(x,T){var k=B(x);return this.startOf(T)<=k&&k<=this.endOf(T)},w.isAfter=function(x,T){return B(x)<this.startOf(T)},w.isBefore=function(x,T){return this.endOf(T)<B(x)},w.$g=function(x,T,k){return N.u(x)?this[T]:this.set(k,x)},w.unix=function(){return Math.floor(this.valueOf()/1e3)},w.valueOf=function(){return this.$d.getTime()},w.startOf=function(x,T){var k=this,D=!!N.u(T)||T,L=N.p(x),j=function(Be,ne){var ke=N.w(k.$u?Date.UTC(k.$y,ne,Be):new Date(k.$y,ne,Be),k);return D?ke:ke.endOf(m)},W=function(Be,ne){return N.w(k.toDate()[Be].apply(k.toDate("s"),(D?[0,0,0,0]:[23,59,59,999]).slice(ne)),k)},Q=this.$W,ee=this.$M,ae=this.$D,je="set"+(this.$u?"UTC":"");switch(L){case y:return D?j(1,0):j(31,11);case h:return D?j(1,ee):j(0,ee+1);case v:var Oe=this.$locale().weekStart||0,tt=(Q<Oe?Q+7:Q)-Oe;return j(D?ae-tt:ae+(6-tt),ee);case m:case S:return W(je+"Hours",0);case d:return W(je+"Minutes",1);case u:return W(je+"Seconds",2);case a:return W(je+"Milliseconds",3);default:return this.clone()}},w.endOf=function(x){return this.startOf(x,!1)},w.$set=function(x,T){var k,D=N.p(x),L="set"+(this.$u?"UTC":""),j=(k={},k[m]=L+"Date",k[S]=L+"Date",k[h]=L+"Month",k[y]=L+"FullYear",k[d]=L+"Hours",k[u]=L+"Minutes",k[a]=L+"Seconds",k[i]=L+"Milliseconds",k)[D],W=D===m?this.$D+(T-this.$W):T;if(D===h||D===y){var Q=this.clone().set(S,1);Q.$d[j](W),Q.init(),this.$d=Q.set(S,Math.min(this.$D,Q.daysInMonth())).$d}else j&&this.$d[j](W);return this.init(),this},w.set=function(x,T){return this.clone().$set(x,T)},w.get=function(x){return this[N.p(x)]()},w.add=function(x,T){var k,D=this;x=Number(x);var L=N.p(T),j=function(ee){var ae=B(D);return N.w(ae.date(ae.date()+Math.round(ee*x)),D)};if(L===h)return this.set(h,this.$M+x);if(L===y)return this.set(y,this.$y+x);if(L===m)return j(1);if(L===v)return j(7);var W=(k={},k[u]=r,k[d]=s,k[a]=n,k)[L]||1,Q=this.$d.getTime()+x*W;return N.w(Q,this)},w.subtract=function(x,T){return this.add(-1*x,T)},w.format=function(x){var T=this,k=this.$locale();if(!this.isValid())return k.invalidDate||b;var D=x||"YYYY-MM-DDTHH:mm:ssZ",L=N.z(this),j=this.$H,W=this.$m,Q=this.$M,ee=k.weekdays,ae=k.months,je=k.meridiem,Oe=function(ne,ke,nt,bt){return ne&&(ne[ke]||ne(T,D))||nt[ke].slice(0,bt)},tt=function(ne){return N.s(j%12||12,ne,"0")},Be=je||function(ne,ke,nt){var bt=ne<12?"AM":"PM";return nt?bt.toLowerCase():bt};return D.replace(I,function(ne,ke){return ke||function(nt){switch(nt){case"YY":return String(T.$y).slice(-2);case"YYYY":return N.s(T.$y,4,"0");case"M":return Q+1;case"MM":return N.s(Q+1,2,"0");case"MMM":return Oe(k.monthsShort,Q,ae,3);case"MMMM":return Oe(ae,Q);case"D":return T.$D;case"DD":return N.s(T.$D,2,"0");case"d":return String(T.$W);case"dd":return Oe(k.weekdaysMin,T.$W,ee,2);case"ddd":return Oe(k.weekdaysShort,T.$W,ee,3);case"dddd":return ee[T.$W];case"H":return String(j);case"HH":return N.s(j,2,"0");case"h":return tt(1);case"hh":return tt(2);case"a":return Be(j,W,!0);case"A":return Be(j,W,!1);case"m":return String(W);case"mm":return N.s(W,2,"0");case"s":return String(T.$s);case"ss":return N.s(T.$s,2,"0");case"SSS":return N.s(T.$ms,3,"0");case"Z":return L}return null}(ne)||L.replace(":","")})},w.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},w.diff=function(x,T,k){var D,L=this,j=N.p(T),W=B(x),Q=(W.utcOffset()-this.utcOffset())*r,ee=this-W,ae=function(){return N.m(L,W)};switch(j){case y:D=ae()/12;break;case h:D=ae();break;case p:D=ae()/3;break;case v:D=(ee-Q)/6048e5;break;case m:D=(ee-Q)/864e5;break;case d:D=ee/s;break;case u:D=ee/r;break;case a:D=ee/n;break;default:D=ee}return k?D:N.a(D)},w.daysInMonth=function(){return this.endOf(h).$D},w.$locale=function(){return A[this.$L]},w.locale=function(x,T){if(!x)return this.$L;var k=this.clone(),D=z(x,T,!0);return D&&(k.$L=D),k},w.clone=function(){return N.w(this.$d,this)},w.toDate=function(){return new Date(this.valueOf())},w.toJSON=function(){return this.isValid()?this.toISOString():null},w.toISOString=function(){return this.$d.toISOString()},w.toString=function(){return this.$d.toUTCString()},M}(),J=K.prototype;return B.prototype=J,[["$ms",i],["$s",a],["$m",u],["$H",d],["$W",m],["$M",h],["$y",y],["$D",S]].forEach(function(M){J[M[1]]=function(w){return this.$g(w,M[0],M[1])}}),B.extend=function(M,w){return M.$i||(M(w,K,B),M.$i=!0),B},B.locale=z,B.isDayjs=E,B.unix=function(M){return B(1e3*M)},B.en=A[O],B.Ls=A,B.p={},B})})(yn);var vn=yn.exports,bn={exports:{}};(function(t,e){(function(n,r){t.exports=r()})(gn,function(){var n,r,s=1e3,i=6e4,a=36e5,u=864e5,d=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,m=31536e6,v=2628e6,h=/^(-|\+)?P(?:([-+]?[0-9,.]*)Y)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)W)?(?:([-+]?[0-9,.]*)D)?(?:T(?:([-+]?[0-9,.]*)H)?(?:([-+]?[0-9,.]*)M)?(?:([-+]?[0-9,.]*)S)?)?$/,p={years:m,months:v,days:u,hours:a,minutes:i,seconds:s,milliseconds:1,weeks:6048e5},y=function(A){return A instanceof U},S=function(A,C,E){return new U(A,E,C.$l)},b=function(A){return r.p(A)+"s"},F=function(A){return A<0},I=function(A){return F(A)?Math.ceil(A):Math.floor(A)},Y=function(A){return Math.abs(A)},R=function(A,C){return A?F(A)?{negative:!0,format:""+Y(A)+C}:{negative:!1,format:""+A+C}:{negative:!1,format:""}},U=function(){function A(E,z,B){var N=this;if(this.$d={},this.$l=B,E===void 0&&(this.$ms=0,this.parseFromMilliseconds()),z)return S(E*p[b(z)],this);if(typeof E=="number")return this.$ms=E,this.parseFromMilliseconds(),this;if(typeof E=="object")return Object.keys(E).forEach(function(M){N.$d[b(M)]=E[M]}),this.calMilliseconds(),this;if(typeof E=="string"){var K=E.match(h);if(K){var J=K.slice(2).map(function(M){return M!=null?Number(M):0});return this.$d.years=J[0],this.$d.months=J[1],this.$d.weeks=J[2],this.$d.days=J[3],this.$d.hours=J[4],this.$d.minutes=J[5],this.$d.seconds=J[6],this.calMilliseconds(),this}}return this}var C=A.prototype;return C.calMilliseconds=function(){var E=this;this.$ms=Object.keys(this.$d).reduce(function(z,B){return z+(E.$d[B]||0)*p[B]},0)},C.parseFromMilliseconds=function(){var E=this.$ms;this.$d.years=I(E/m),E%=m,this.$d.months=I(E/v),E%=v,this.$d.days=I(E/u),E%=u,this.$d.hours=I(E/a),E%=a,this.$d.minutes=I(E/i),E%=i,this.$d.seconds=I(E/s),E%=s,this.$d.milliseconds=E},C.toISOString=function(){var E=R(this.$d.years,"Y"),z=R(this.$d.months,"M"),B=+this.$d.days||0;this.$d.weeks&&(B+=7*this.$d.weeks);var N=R(B,"D"),K=R(this.$d.hours,"H"),J=R(this.$d.minutes,"M"),M=this.$d.seconds||0;this.$d.milliseconds&&(M+=this.$d.milliseconds/1e3,M=Math.round(1e3*M)/1e3);var w=R(M,"S"),x=E.negative||z.negative||N.negative||K.negative||J.negative||w.negative,T=K.format||J.format||w.format?"T":"",k=(x?"-":"")+"P"+E.format+z.format+N.format+T+K.format+J.format+w.format;return k==="P"||k==="-P"?"P0D":k},C.toJSON=function(){return this.toISOString()},C.format=function(E){var z=E||"YYYY-MM-DDTHH:mm:ss",B={Y:this.$d.years,YY:r.s(this.$d.years,2,"0"),YYYY:r.s(this.$d.years,4,"0"),M:this.$d.months,MM:r.s(this.$d.months,2,"0"),D:this.$d.days,DD:r.s(this.$d.days,2,"0"),H:this.$d.hours,HH:r.s(this.$d.hours,2,"0"),m:this.$d.minutes,mm:r.s(this.$d.minutes,2,"0"),s:this.$d.seconds,ss:r.s(this.$d.seconds,2,"0"),SSS:r.s(this.$d.milliseconds,3,"0")};return z.replace(d,function(N,K){return K||String(B[N])})},C.as=function(E){return this.$ms/p[b(E)]},C.get=function(E){var z=this.$ms,B=b(E);return B==="milliseconds"?z%=1e3:z=B==="weeks"?I(z/p[B]):this.$d[B],z||0},C.add=function(E,z,B){var N;return N=z?E*p[b(z)]:y(E)?E.$ms:S(E,this).$ms,S(this.$ms+N*(B?-1:1),this)},C.subtract=function(E,z){return this.add(E,z,!0)},C.locale=function(E){var z=this.clone();return z.$l=E,z},C.clone=function(){return S(this.$ms,this)},C.humanize=function(E){return n().add(this.$ms,"ms").locale(this.$l).fromNow(!E)},C.valueOf=function(){return this.asMilliseconds()},C.milliseconds=function(){return this.get("milliseconds")},C.asMilliseconds=function(){return this.as("milliseconds")},C.seconds=function(){return this.get("seconds")},C.asSeconds=function(){return this.as("seconds")},C.minutes=function(){return this.get("minutes")},C.asMinutes=function(){return this.as("minutes")},C.hours=function(){return this.get("hours")},C.asHours=function(){return this.as("hours")},C.days=function(){return this.get("days")},C.asDays=function(){return this.as("days")},C.weeks=function(){return this.get("weeks")},C.asWeeks=function(){return this.as("weeks")},C.months=function(){return this.get("months")},C.asMonths=function(){return this.as("months")},C.years=function(){return this.get("years")},C.asYears=function(){return this.as("years")},A}(),O=function(A,C,E){return A.add(C.years()*E,"y").add(C.months()*E,"M").add(C.days()*E,"d").add(C.hours()*E,"h").add(C.minutes()*E,"m").add(C.seconds()*E,"s").add(C.milliseconds()*E,"ms")};return function(A,C,E){n=E,r=E().$utils(),E.duration=function(N,K){var J=E.locale();return S(N,{$l:J},K)},E.isDuration=y;var z=C.prototype.add,B=C.prototype.subtract;C.prototype.add=function(N,K){return y(N)?O(this,N,1):z.bind(this)(N,K)},C.prototype.subtract=function(N,K){return y(N)?O(this,N,-1):B.bind(this)(N,K)}}})})(bn);var Ur=bn.exports;const Fr=Nt(Ur),Rt=(t,e)=>((t+e-1)/e|0)*e;function zr(t){return Object.keys(t)}function Pr(t,e){return new Array(t).fill(0).map((n,r)=>e(r))}const xn=t=>t&&typeof t.length=="number"&&t.buffer instanceof ArrayBuffer&&typeof t.byteLength=="number",V={i32:{numElements:1,align:4,size:4,type:"i32",View:Int32Array},u32:{numElements:1,align:4,size:4,type:"u32",View:Uint32Array},f32:{numElements:1,align:4,size:4,type:"f32",View:Float32Array},f16:{numElements:1,align:2,size:2,type:"u16",View:Uint16Array},vec2f:{numElements:2,align:8,size:8,type:"f32",View:Float32Array},vec2i:{numElements:2,align:8,size:8,type:"i32",View:Int32Array},vec2u:{numElements:2,align:8,size:8,type:"u32",View:Uint32Array},vec2h:{numElements:2,align:4,size:4,type:"u16",View:Uint16Array},vec3i:{numElements:3,align:16,size:12,type:"i32",View:Int32Array},vec3u:{numElements:3,align:16,size:12,type:"u32",View:Uint32Array},vec3f:{numElements:3,align:16,size:12,type:"f32",View:Float32Array},vec3h:{numElements:3,align:8,size:6,type:"u16",View:Uint16Array},vec4i:{numElements:4,align:16,size:16,type:"i32",View:Int32Array},vec4u:{numElements:4,align:16,size:16,type:"u32",View:Uint32Array},vec4f:{numElements:4,align:16,size:16,type:"f32",View:Float32Array},vec4h:{numElements:4,align:8,size:8,type:"u16",View:Uint16Array},mat2x2f:{numElements:4,align:8,size:16,type:"f32",View:Float32Array},mat2x2h:{numElements:4,align:4,size:8,type:"u16",View:Uint16Array},mat3x2f:{numElements:6,align:8,size:24,type:"f32",View:Float32Array},mat3x2h:{numElements:6,align:4,size:12,type:"u16",View:Uint16Array},mat4x2f:{numElements:8,align:8,size:32,type:"f32",View:Float32Array},mat4x2h:{numElements:8,align:4,size:16,type:"u16",View:Uint16Array},mat2x3f:{numElements:8,align:16,size:32,pad:[3,1],type:"f32",View:Float32Array},mat2x3h:{numElements:8,align:8,size:16,pad:[3,1],type:"u16",View:Uint16Array},mat3x3f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x3h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x3f:{numElements:16,align:16,size:64,pad:[3,1],type:"f32",View:Float32Array},mat4x3h:{numElements:16,align:8,size:32,pad:[3,1],type:"u16",View:Uint16Array},mat2x4f:{numElements:8,align:16,size:32,type:"f32",View:Float32Array},mat2x4h:{numElements:8,align:8,size:16,type:"u16",View:Uint16Array},mat3x4f:{numElements:12,align:16,size:48,pad:[3,1],type:"f32",View:Float32Array},mat3x4h:{numElements:12,align:8,size:24,pad:[3,1],type:"u16",View:Uint16Array},mat4x4f:{numElements:16,align:16,size:64,type:"f32",View:Float32Array},mat4x4h:{numElements:16,align:8,size:32,type:"u16",View:Uint16Array},bool:{numElements:0,align:1,size:0,type:"bool",View:Uint32Array}},Ue={...V,"vec2<i32>":V.vec2i,"vec2<u32>":V.vec2u,"vec2<f32>":V.vec2f,"vec2<f16>":V.vec2h,"vec3<i32>":V.vec3i,"vec3<u32>":V.vec3u,"vec3<f32>":V.vec3f,"vec3<f16>":V.vec3h,"vec4<i32>":V.vec4i,"vec4<u32>":V.vec4u,"vec4<f32>":V.vec4f,"vec4<f16>":V.vec4h,"mat2x2<f32>":V.mat2x2f,"mat2x2<f16>":V.mat2x2h,"mat3x2<f32>":V.mat3x2f,"mat3x2<f16>":V.mat3x2h,"mat4x2<f32>":V.mat4x2f,"mat4x2<f16>":V.mat4x2h,"mat2x3<f32>":V.mat2x3f,"mat2x3<f16>":V.mat2x3h,"mat3x3<f32>":V.mat3x3f,"mat3x3<f16>":V.mat3x3h,"mat4x3<f32>":V.mat4x3f,"mat4x3<f16>":V.mat4x3h,"mat2x4<f32>":V.mat2x4f,"mat2x4<f16>":V.mat2x4h,"mat3x4<f32>":V.mat3x4f,"mat3x4<f16>":V.mat3x4h,"mat4x4<f32>":V.mat4x4f,"mat4x4<f16>":V.mat4x4h},Vr=zr(Ue);function $r(t=[],e){const n=new Set;for(const r of Vr){const s=Ue[r];n.has(s)||(n.add(s),s.flatten=t.includes(r)?e:!e)}}$r();function Gr(t){const e=t;if(e.elementType)return e.size;{const n=t,r=e.numElements||1;if(n.fields)return t.size*r;{const s=t,{align:i}=Ue[s.type];return r>1?Rt(t.size,i)*r:t.size}}}function wn(t,e,n,r){const{size:s,type:i}=t;try{const{View:a,align:u}=Ue[i],d=r!==void 0,m=d?Rt(s,u):s,v=m/a.BYTES_PER_ELEMENT,h=d?r===0?(e.byteLength-n)/m:r:1;return new a(e,n,v*h)}catch{throw new Error(`unknown type: ${i}`)}}function Hr(t){return!t.fields&&!t.elementType}function jr(t,e,n){const r=n||0,s=e||new ArrayBuffer(Gr(t)),i=(a,u)=>{const d=a,m=d.elementType;if(m){if(Hr(m)&&Ue[m.type].flatten)return wn(m,s,u,d.numElements);{const{size:v}=En(a),h=d.numElements===0?(s.byteLength-u)/v:d.numElements;return Pr(h,p=>i(m,u+v*p))}}else{if(typeof a=="string")throw Error("unreachable");{const v=a.fields;if(v){const h={};for(const[p,{type:y,offset:S}]of Object.entries(v))h[p]=i(y,u+S);return h}else return wn(a,s,u)}}};return{views:i(t,r),arrayBuffer:s}}function Ot(t,e){if(t!==void 0)if(xn(e)){const n=e;if(n.length===1&&typeof t=="number")n[0]=t;else if(Array.isArray(t[0])||xn(t[0])){const r=t[0].length,s=r===3?4:r;for(let i=0;i<t.length;++i){const a=i*s;n.set(t[i],a)}}else n.set(t)}else if(Array.isArray(e)){const n=e;t.forEach((r,s)=>{Ot(r,n[s])})}else{const n=e;for(const[r,s]of Object.entries(t)){const i=n[r];i&&Ot(s,i)}}}function kn(t,e,n=0){const r=t,s=r.group===void 0?t:r.typeDefinition,i=jr(s,e,n);return{...i,set(a){Ot(a,i.views)}}}function Bt(t){const e=t.elementType;if(e)return Bt(e);const n=t.fields;if(n)return Object.values(n).reduce((i,{type:a})=>Math.max(i,Bt(a)),0);const{type:r}=t,{align:s}=Ue[r];return s}function En(t){const e=t.elementType;if(e){const r=e.size,s=Bt(e);return{unalignedSize:r,align:s,size:Rt(r,s)}}const n=t.fields;if(n){const r=Object.values(n).pop();if(r.type.size===0)return En(r.type)}return{size:0,unalignedSize:0,align:1}}class qr{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class pe{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw new Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}search(e){}searchBlock(e,n){if(e){n(ot.instance);for(const r of e)r instanceof Array?this.searchBlock(r,n):r.search(n);n(ut.instance)}}}class ot extends pe{}ot.instance=new ot;class ut extends pe{}ut.instance=new ut;class X extends pe{constructor(){super()}}let Dt=class extends X{constructor(t,e,n,r){super(),this.name=t,this.args=e,this.returnType=n,this.body=r}get astNodeType(){return"function"}search(t){this.searchBlock(this.body,t)}};class Xr extends X{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class Yr extends X{constructor(e,n){super(),this.condition=e,this.body=n}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Kr extends X{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class Wr extends X{constructor(e,n,r,s){super(),this.init=e,this.condition=n,this.increment=r,this.body=s}get astNodeType(){return"for"}search(e){var n,r,s;(n=this.init)===null||n===void 0||n.search(e),(r=this.condition)===null||r===void 0||r.search(e),(s=this.increment)===null||s===void 0||s.search(e),this.searchBlock(this.body,e)}}class Ae extends X{constructor(e,n,r,s,i){super(),this.name=e,this.type=n,this.storage=r,this.access=s,this.value=i}get astNodeType(){return"var"}search(e){var n;e(this),(n=this.value)===null||n===void 0||n.search(e)}}class Sn extends X{constructor(e,n,r){super(),this.name=e,this.type=n,this.value=r}get astNodeType(){return"override"}search(e){var n;(n=this.value)===null||n===void 0||n.search(e)}}class Lt extends X{constructor(e,n,r,s,i){super(),this.name=e,this.type=n,this.storage=r,this.access=s,this.value=i}get astNodeType(){return"let"}search(e){var n;(n=this.value)===null||n===void 0||n.search(e)}}class An extends X{constructor(e,n,r,s,i){super(),this.name=e,this.type=n,this.storage=r,this.access=s,this.value=i}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var n;(n=this.value)===null||n===void 0||n.search(e)}}var Fe;(function(t){t.increment="++",t.decrement="--"})(Fe||(Fe={})),function(t){function e(n){const r=n;if(r=="parse")throw new Error("Invalid value for IncrementOperator");return t[r]}t.parse=e}(Fe||(Fe={}));class Zr extends X{constructor(e,n){super(),this.operator=e,this.variable=n}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}var Je;(function(t){t.assign="=",t.addAssign="+=",t.subtractAssin="-=",t.multiplyAssign="*=",t.divideAssign="/=",t.moduloAssign="%=",t.andAssign="&=",t.orAssign="|=",t.xorAssign="^=",t.shiftLeftAssign="<<=",t.shiftRightAssign=">>="})(Je||(Je={})),function(t){function e(n){const r=n;if(r=="parse")throw new Error("Invalid value for AssignOperator");return r}t.parse=e}(Je||(Je={}));class Jr extends X{constructor(e,n,r){super(),this.operator=e,this.variable=n,this.value=r}get astNodeType(){return"assign"}search(e){this.value.search(e)}}class Qr extends X{constructor(e,n){super(),this.name=e,this.args=n}get astNodeType(){return"call"}}class es extends X{constructor(e,n){super(),this.body=e,this.continuing=n}get astNodeType(){return"loop"}}class ts extends X{constructor(e,n){super(),this.condition=e,this.body=n}get astNodeType(){return"body"}}class ns extends X{constructor(e,n,r,s){super(),this.condition=e,this.body=n,this.elseif=r,this.else=s}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class rs extends X{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var n;(n=this.value)===null||n===void 0||n.search(e)}}class ss extends X{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Mn extends X{constructor(e,n){super(),this.name=e,this.type=n}get astNodeType(){return"alias"}}class is extends X{constructor(){super()}get astNodeType(){return"discard"}}class as extends X{constructor(){super()}get astNodeType(){return"break"}}class os extends X{constructor(){super()}get astNodeType(){return"continue"}}class Me extends X{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class Te extends Me{constructor(e,n){super(e),this.members=n}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let n=0;n<this.members.length;n++)if(this.members[n].name==e)return n;return-1}}class Tn extends Me{constructor(e,n,r){super(e),this.format=n,this.access=r}get astNodeType(){return"template"}}class us extends Me{constructor(e,n,r,s){super(e),this.storage=n,this.type=r,this.access=s}get astNodeType(){return"pointer"}}class In extends Me{constructor(e,n,r,s){super(e),this.attributes=n,this.format=r,this.count=s}get astNodeType(){return"array"}get isArray(){return!0}}class Qe extends Me{constructor(e,n,r){super(e),this.format=n,this.access=r}get astNodeType(){return"sampler"}}class he extends pe{constructor(){super()}}class Cn extends he{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class et extends he{constructor(e,n){super(),this.type=e,this.args=n}get astNodeType(){return"createExpr"}}class Nn extends he{constructor(e,n){super(),this.name=e,this.args=n}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return this.args[0].evaluate(e)*180/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function: "+this.name)}}search(e){for(const n of this.args)n.search(e);e(this)}}class Rn extends he{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this)}}class On extends he{constructor(e,n){super(),this.name=e,this.initializer=n}get astNodeType(){return"constExpr"}evaluate(e){var n,r;if(this.initializer instanceof et){const s=(n=this.postfix)===null||n===void 0?void 0:n.evaluateString(e),i=(r=this.initializer.type)===null||r===void 0?void 0:r.name,a=e.structs.get(i),u=a==null?void 0:a.getMemberIndex(s);if(u!=-1)return this.initializer.args[u].evaluate(e);console.log(u)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class Bn extends he{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class cs extends he{constructor(e,n){super(),this.type=e,this.value=n}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class ls extends he{constructor(e,n){super(),this.type=e,this.args=n}get astNodeType(){return"typecastExpr"}evaluate(e){return this.args[0].evaluate(e)}search(e){this.searchBlock(this.args,e)}}class Dn extends he{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class Ln extends he{constructor(){super()}}class hs extends Ln{constructor(e,n){super(),this.operator=e,this.right=n}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator: "+this.operator)}}search(e){this.right.search(e)}}class de extends Ln{constructor(e,n,r){super(),this.operator=e,this.left=n,this.right=r}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class Un extends pe{constructor(){super()}}class ds extends Un{constructor(e,n){super(),this.selector=e,this.body=n}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class _s extends Un{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class ps extends pe{constructor(e,n,r){super(),this.name=e,this.type=n,this.attributes=r}get astNodeType(){return"argument"}}class fs extends pe{constructor(e,n){super(),this.condition=e,this.body=n}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class ms extends pe{constructor(e,n,r){super(),this.name=e,this.type=n,this.attributes=r}get astNodeType(){return"member"}}class Fn extends pe{constructor(e,n){super(),this.name=e,this.value=n}get astNodeType(){return"attribute"}}var f,c;(function(t){t[t.token=0]="token",t[t.keyword=1]="keyword",t[t.reserved=2]="reserved"})(c||(c={}));class l{constructor(e,n,r){this.name=e,this.type=n,this.rule=r}toString(){return this.name}}class o{}f=o,o.none=new l("",c.reserved,""),o.eof=new l("EOF",c.token,""),o.reserved={asm:new l("asm",c.reserved,"asm"),bf16:new l("bf16",c.reserved,"bf16"),do:new l("do",c.reserved,"do"),enum:new l("enum",c.reserved,"enum"),f16:new l("f16",c.reserved,"f16"),f64:new l("f64",c.reserved,"f64"),handle:new l("handle",c.reserved,"handle"),i8:new l("i8",c.reserved,"i8"),i16:new l("i16",c.reserved,"i16"),i64:new l("i64",c.reserved,"i64"),mat:new l("mat",c.reserved,"mat"),premerge:new l("premerge",c.reserved,"premerge"),regardless:new l("regardless",c.reserved,"regardless"),typedef:new l("typedef",c.reserved,"typedef"),u8:new l("u8",c.reserved,"u8"),u16:new l("u16",c.reserved,"u16"),u64:new l("u64",c.reserved,"u64"),unless:new l("unless",c.reserved,"unless"),using:new l("using",c.reserved,"using"),vec:new l("vec",c.reserved,"vec"),void:new l("void",c.reserved,"void")},o.keywords={array:new l("array",c.keyword,"array"),atomic:new l("atomic",c.keyword,"atomic"),bool:new l("bool",c.keyword,"bool"),f32:new l("f32",c.keyword,"f32"),i32:new l("i32",c.keyword,"i32"),mat2x2:new l("mat2x2",c.keyword,"mat2x2"),mat2x3:new l("mat2x3",c.keyword,"mat2x3"),mat2x4:new l("mat2x4",c.keyword,"mat2x4"),mat3x2:new l("mat3x2",c.keyword,"mat3x2"),mat3x3:new l("mat3x3",c.keyword,"mat3x3"),mat3x4:new l("mat3x4",c.keyword,"mat3x4"),mat4x2:new l("mat4x2",c.keyword,"mat4x2"),mat4x3:new l("mat4x3",c.keyword,"mat4x3"),mat4x4:new l("mat4x4",c.keyword,"mat4x4"),ptr:new l("ptr",c.keyword,"ptr"),sampler:new l("sampler",c.keyword,"sampler"),sampler_comparison:new l("sampler_comparison",c.keyword,"sampler_comparison"),struct:new l("struct",c.keyword,"struct"),texture_1d:new l("texture_1d",c.keyword,"texture_1d"),texture_2d:new l("texture_2d",c.keyword,"texture_2d"),texture_2d_array:new l("texture_2d_array",c.keyword,"texture_2d_array"),texture_3d:new l("texture_3d",c.keyword,"texture_3d"),texture_cube:new l("texture_cube",c.keyword,"texture_cube"),texture_cube_array:new l("texture_cube_array",c.keyword,"texture_cube_array"),texture_multisampled_2d:new l("texture_multisampled_2d",c.keyword,"texture_multisampled_2d"),texture_storage_1d:new l("texture_storage_1d",c.keyword,"texture_storage_1d"),texture_storage_2d:new l("texture_storage_2d",c.keyword,"texture_storage_2d"),texture_storage_2d_array:new l("texture_storage_2d_array",c.keyword,"texture_storage_2d_array"),texture_storage_3d:new l("texture_storage_3d",c.keyword,"texture_storage_3d"),texture_depth_2d:new l("texture_depth_2d",c.keyword,"texture_depth_2d"),texture_depth_2d_array:new l("texture_depth_2d_array",c.keyword,"texture_depth_2d_array"),texture_depth_cube:new l("texture_depth_cube",c.keyword,"texture_depth_cube"),texture_depth_cube_array:new l("texture_depth_cube_array",c.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new l("texture_depth_multisampled_2d",c.keyword,"texture_depth_multisampled_2d"),texture_external:new l("texture_external",c.keyword,"texture_external"),u32:new l("u32",c.keyword,"u32"),vec2:new l("vec2",c.keyword,"vec2"),vec3:new l("vec3",c.keyword,"vec3"),vec4:new l("vec4",c.keyword,"vec4"),bitcast:new l("bitcast",c.keyword,"bitcast"),block:new l("block",c.keyword,"block"),break:new l("break",c.keyword,"break"),case:new l("case",c.keyword,"case"),continue:new l("continue",c.keyword,"continue"),continuing:new l("continuing",c.keyword,"continuing"),default:new l("default",c.keyword,"default"),discard:new l("discard",c.keyword,"discard"),else:new l("else",c.keyword,"else"),enable:new l("enable",c.keyword,"enable"),fallthrough:new l("fallthrough",c.keyword,"fallthrough"),false:new l("false",c.keyword,"false"),fn:new l("fn",c.keyword,"fn"),for:new l("for",c.keyword,"for"),function:new l("function",c.keyword,"function"),if:new l("if",c.keyword,"if"),let:new l("let",c.keyword,"let"),const:new l("const",c.keyword,"const"),loop:new l("loop",c.keyword,"loop"),while:new l("while",c.keyword,"while"),private:new l("private",c.keyword,"private"),read:new l("read",c.keyword,"read"),read_write:new l("read_write",c.keyword,"read_write"),return:new l("return",c.keyword,"return"),storage:new l("storage",c.keyword,"storage"),switch:new l("switch",c.keyword,"switch"),true:new l("true",c.keyword,"true"),alias:new l("alias",c.keyword,"alias"),type:new l("type",c.keyword,"type"),uniform:new l("uniform",c.keyword,"uniform"),var:new l("var",c.keyword,"var"),override:new l("override",c.keyword,"override"),workgroup:new l("workgroup",c.keyword,"workgroup"),write:new l("write",c.keyword,"write"),r8unorm:new l("r8unorm",c.keyword,"r8unorm"),r8snorm:new l("r8snorm",c.keyword,"r8snorm"),r8uint:new l("r8uint",c.keyword,"r8uint"),r8sint:new l("r8sint",c.keyword,"r8sint"),r16uint:new l("r16uint",c.keyword,"r16uint"),r16sint:new l("r16sint",c.keyword,"r16sint"),r16float:new l("r16float",c.keyword,"r16float"),rg8unorm:new l("rg8unorm",c.keyword,"rg8unorm"),rg8snorm:new l("rg8snorm",c.keyword,"rg8snorm"),rg8uint:new l("rg8uint",c.keyword,"rg8uint"),rg8sint:new l("rg8sint",c.keyword,"rg8sint"),r32uint:new l("r32uint",c.keyword,"r32uint"),r32sint:new l("r32sint",c.keyword,"r32sint"),r32float:new l("r32float",c.keyword,"r32float"),rg16uint:new l("rg16uint",c.keyword,"rg16uint"),rg16sint:new l("rg16sint",c.keyword,"rg16sint"),rg16float:new l("rg16float",c.keyword,"rg16float"),rgba8unorm:new l("rgba8unorm",c.keyword,"rgba8unorm"),rgba8unorm_srgb:new l("rgba8unorm_srgb",c.keyword,"rgba8unorm_srgb"),rgba8snorm:new l("rgba8snorm",c.keyword,"rgba8snorm"),rgba8uint:new l("rgba8uint",c.keyword,"rgba8uint"),rgba8sint:new l("rgba8sint",c.keyword,"rgba8sint"),bgra8unorm:new l("bgra8unorm",c.keyword,"bgra8unorm"),bgra8unorm_srgb:new l("bgra8unorm_srgb",c.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new l("rgb10a2unorm",c.keyword,"rgb10a2unorm"),rg11b10float:new l("rg11b10float",c.keyword,"rg11b10float"),rg32uint:new l("rg32uint",c.keyword,"rg32uint"),rg32sint:new l("rg32sint",c.keyword,"rg32sint"),rg32float:new l("rg32float",c.keyword,"rg32float"),rgba16uint:new l("rgba16uint",c.keyword,"rgba16uint"),rgba16sint:new l("rgba16sint",c.keyword,"rgba16sint"),rgba16float:new l("rgba16float",c.keyword,"rgba16float"),rgba32uint:new l("rgba32uint",c.keyword,"rgba32uint"),rgba32sint:new l("rgba32sint",c.keyword,"rgba32sint"),rgba32float:new l("rgba32float",c.keyword,"rgba32float"),static_assert:new l("static_assert",c.keyword,"static_assert")},o.tokens={decimal_float_literal:new l("decimal_float_literal",c.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|([0-9]+f)/),hex_float_literal:new l("hex_float_literal",c.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new l("int_literal",c.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new l("uint_literal",c.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new l("ident",c.token,/[a-zA-Z][0-9a-zA-Z_]*/),and:new l("and",c.token,"&"),and_and:new l("and_and",c.token,"&&"),arrow:new l("arrow ",c.token,"->"),attr:new l("attr",c.token,"@"),attr_left:new l("attr_left",c.token,"[["),attr_right:new l("attr_right",c.token,"]]"),forward_slash:new l("forward_slash",c.token,"/"),bang:new l("bang",c.token,"!"),bracket_left:new l("bracket_left",c.token,"["),bracket_right:new l("bracket_right",c.token,"]"),brace_left:new l("brace_left",c.token,"{"),brace_right:new l("brace_right",c.token,"}"),colon:new l("colon",c.token,":"),comma:new l("comma",c.token,","),equal:new l("equal",c.token,"="),equal_equal:new l("equal_equal",c.token,"=="),not_equal:new l("not_equal",c.token,"!="),greater_than:new l("greater_than",c.token,">"),greater_than_equal:new l("greater_than_equal",c.token,">="),shift_right:new l("shift_right",c.token,">>"),less_than:new l("less_than",c.token,"<"),less_than_equal:new l("less_than_equal",c.token,"<="),shift_left:new l("shift_left",c.token,"<<"),modulo:new l("modulo",c.token,"%"),minus:new l("minus",c.token,"-"),minus_minus:new l("minus_minus",c.token,"--"),period:new l("period",c.token,"."),plus:new l("plus",c.token,"+"),plus_plus:new l("plus_plus",c.token,"++"),or:new l("or",c.token,"|"),or_or:new l("or_or",c.token,"||"),paren_left:new l("paren_left",c.token,"("),paren_right:new l("paren_right",c.token,")"),semicolon:new l("semicolon",c.token,";"),star:new l("star",c.token,"*"),tilde:new l("tilde",c.token,"~"),underscore:new l("underscore",c.token,"_"),xor:new l("xor",c.token,"^"),plus_equal:new l("plus_equal",c.token,"+="),minus_equal:new l("minus_equal",c.token,"-="),times_equal:new l("times_equal",c.token,"*="),division_equal:new l("division_equal",c.token,"/="),modulo_equal:new l("modulo_equal",c.token,"%="),and_equal:new l("and_equal",c.token,"&="),or_equal:new l("or_equal",c.token,"|="),xor_equal:new l("xor_equal",c.token,"^="),shift_right_equal:new l("shift_right_equal",c.token,">>="),shift_left_equal:new l("shift_left_equal",c.token,"<<=")},o.storage_class=[f.keywords.function,f.keywords.private,f.keywords.workgroup,f.keywords.uniform,f.keywords.storage],o.access_mode=[f.keywords.read,f.keywords.write,f.keywords.read_write],o.sampler_type=[f.keywords.sampler,f.keywords.sampler_comparison],o.sampled_texture_type=[f.keywords.texture_1d,f.keywords.texture_2d,f.keywords.texture_2d_array,f.keywords.texture_3d,f.keywords.texture_cube,f.keywords.texture_cube_array],o.multisampled_texture_type=[f.keywords.texture_multisampled_2d],o.storage_texture_type=[f.keywords.texture_storage_1d,f.keywords.texture_storage_2d,f.keywords.texture_storage_2d_array,f.keywords.texture_storage_3d],o.depth_texture_type=[f.keywords.texture_depth_2d,f.keywords.texture_depth_2d_array,f.keywords.texture_depth_cube,f.keywords.texture_depth_cube_array,f.keywords.texture_depth_multisampled_2d],o.texture_external_type=[f.keywords.texture_external],o.any_texture_type=[...f.sampled_texture_type,...f.multisampled_texture_type,...f.storage_texture_type,...f.depth_texture_type,...f.texture_external_type],o.texel_format=[f.keywords.r8unorm,f.keywords.r8snorm,f.keywords.r8uint,f.keywords.r8sint,f.keywords.r16uint,f.keywords.r16sint,f.keywords.r16float,f.keywords.rg8unorm,f.keywords.rg8snorm,f.keywords.rg8uint,f.keywords.rg8sint,f.keywords.r32uint,f.keywords.r32sint,f.keywords.r32float,f.keywords.rg16uint,f.keywords.rg16sint,f.keywords.rg16float,f.keywords.rgba8unorm,f.keywords.rgba8unorm_srgb,f.keywords.rgba8snorm,f.keywords.rgba8uint,f.keywords.rgba8sint,f.keywords.bgra8unorm,f.keywords.bgra8unorm_srgb,f.keywords.rgb10a2unorm,f.keywords.rg11b10float,f.keywords.rg32uint,f.keywords.rg32sint,f.keywords.rg32float,f.keywords.rgba16uint,f.keywords.rgba16sint,f.keywords.rgba16float,f.keywords.rgba32uint,f.keywords.rgba32sint,f.keywords.rgba32float],o.const_literal=[f.tokens.int_literal,f.tokens.uint_literal,f.tokens.decimal_float_literal,f.tokens.hex_float_literal,f.keywords.true,f.keywords.false],o.literal_or_ident=[f.tokens.ident,f.tokens.int_literal,f.tokens.uint_literal,f.tokens.decimal_float_literal,f.tokens.hex_float_literal],o.element_count_expression=[f.tokens.int_literal,f.tokens.uint_literal,f.tokens.ident],o.template_types=[f.keywords.vec2,f.keywords.vec3,f.keywords.vec4,f.keywords.mat2x2,f.keywords.mat2x3,f.keywords.mat2x4,f.keywords.mat3x2,f.keywords.mat3x3,f.keywords.mat3x4,f.keywords.mat4x2,f.keywords.mat4x3,f.keywords.mat4x4,f.keywords.atomic,f.keywords.bitcast,...f.any_texture_type],o.attribute_name=[f.tokens.ident,f.keywords.block],o.assignment_operators=[f.tokens.equal,f.tokens.plus_equal,f.tokens.minus_equal,f.tokens.times_equal,f.tokens.division_equal,f.tokens.modulo_equal,f.tokens.and_equal,f.tokens.or_equal,f.tokens.xor_equal,f.tokens.shift_right_equal,f.tokens.shift_left_equal],o.increment_operators=[f.tokens.plus_plus,f.tokens.minus_minus];class zn{constructor(e,n,r){this.type=e,this.lexeme=n,this.line=r}toString(){return this.lexeme}isTemplateType(){return o.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==o.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class gs{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new zn(o.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}else if(this._peekAhead()=="*"){this._advance();let r=1;for(;r>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),r--,r==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),r++)}return!0}}let n=o.none;for(;;){let r=this._findType(e);const s=this._peekAhead();if(e==">"&&(s==">"||s=="=")){let i=!1,a=this._tokens.length-1;for(let u=0;u<5&&a>=0;++u,--a)if(this._tokens[a].type===o.tokens.less_than){a>0&&this._tokens[a-1].isArrayOrTemplateType()&&(i=!0);break}if(i)return this._addToken(r),!0}if(r===o.none){let i=e,a=0;const u=2;for(let d=0;d<u;++d)if(i+=this._peekAhead(d),r=this._findType(i),r!==o.none){a=d;break}if(r===o.none)return n===o.none?!1:(this._current--,this._addToken(n),!0);e=i,this._current+=a+1}if(n=r,this._isAtEnd())break;e+=this._advance()}return n===o.none?!1:(this._addToken(n),!0)}_findType(e){for(const n in o.keywords){const r=o.keywords[n];if(this._match(e,r.rule))return r}for(const n in o.tokens){const r=o.tokens[n];if(this._match(e,r.rule))return r}return o.none}_match(e,n){if(typeof n=="string"){if(n==e)return!0}else{const r=n.exec(e);if(r&&r.index==0&&r[0]==e)return!0}return!1}_isAtEnd(){return this._current>=this._source.length}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let n=this._source[this._current];return e=e||0,e++,this._current+=e,n}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const n=this._source.substring(this._start,this._current);this._tokens.push(new zn(e,n,this._line))}}class ys{constructor(){this._tokens=[],this._current=0,this._context=new qr}parse(e){this._initialize(e);let n=[];for(;!this._isAtEnd();){const r=this._global_decl_or_directive();if(!r)break;n.push(r)}return n}_initialize(e){if(e)if(typeof e=="string"){const n=new gs(e);this._tokens=n.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,n){return console.error(e,n),{token:e,message:n,toString:function(){return`${n}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==o.eof}_match(e){if(e instanceof l)return this._check(e)?(this._advance(),!0):!1;for(let n=0,r=e.length;n<r;++n){const s=e[n];if(this._check(s))return this._advance(),!0}return!1}_consume(e,n){if(this._check(e))return this._advance();throw this._error(this._peek(),n)}_check(e){if(this._isAtEnd())return!1;const n=this._peek();if(e instanceof Array){let r=n.type;return e.indexOf(r)!=-1}return n.type==e}_advance(){return this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(o.tokens.semicolon)&&!this._isAtEnd(););if(this._match(o.keywords.alias)){const n=this._type_alias();return this._consume(o.tokens.semicolon,"Expected ';'"),n}if(this._match(o.keywords.enable)){const n=this._enable_directive();return this._consume(o.tokens.semicolon,"Expected ';'"),n}const e=this._attribute();if(this._check(o.keywords.var)){const n=this._global_variable_decl();return n!=null&&(n.attributes=e),this._consume(o.tokens.semicolon,"Expected ';'."),n}if(this._check(o.keywords.override)){const n=this._override_variable_decl();return n!=null&&(n.attributes=e),this._consume(o.tokens.semicolon,"Expected ';'."),n}if(this._check(o.keywords.let)){const n=this._global_let_decl();return n!=null&&(n.attributes=e),this._consume(o.tokens.semicolon,"Expected ';'."),n}if(this._check(o.keywords.const)){const n=this._global_const_decl();return n!=null&&(n.attributes=e),this._consume(o.tokens.semicolon,"Expected ';'."),n}if(this._check(o.keywords.struct)){const n=this._struct_decl();return n!=null&&(n.attributes=e),n}if(this._check(o.keywords.fn)){const n=this._function_decl();return n!=null&&(n.attributes=e),n}return null}_function_decl(){if(!this._match(o.keywords.fn))return null;const e=this._consume(o.tokens.ident,"Expected function name.").toString();this._consume(o.tokens.paren_left,"Expected '(' for function arguments.");const n=[];if(!this._check(o.tokens.paren_right))do{if(this._check(o.tokens.paren_right))break;const i=this._attribute(),a=this._consume(o.tokens.ident,"Expected argument name.").toString();this._consume(o.tokens.colon,"Expected ':' for argument type.");const u=this._attribute(),d=this._type_decl();d!=null&&(d.attributes=u,n.push(new ps(a,d,i)))}while(this._match(o.tokens.comma));this._consume(o.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(o.tokens.arrow)){const i=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=i)}const s=this._compound_statement();return new Dt(e,n,r,s)}_compound_statement(){const e=[];for(this._consume(o.tokens.brace_left,"Expected '{' for block.");!this._check(o.tokens.brace_right);){const n=this._statement();n!==null&&e.push(n)}return this._consume(o.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(o.tokens.semicolon)&&!this._isAtEnd(););if(this._check(o.keywords.if))return this._if_statement();if(this._check(o.keywords.switch))return this._switch_statement();if(this._check(o.keywords.loop))return this._loop_statement();if(this._check(o.keywords.for))return this._for_statement();if(this._check(o.keywords.while))return this._while_statement();if(this._check(o.keywords.continuing))return this._continuing_statement();if(this._check(o.keywords.static_assert))return this._static_assert_statement();if(this._check(o.tokens.brace_left))return this._compound_statement();let e=null;return this._check(o.keywords.return)?e=this._return_statement():this._check([o.keywords.var,o.keywords.let,o.keywords.const])?e=this._variable_statement():this._match(o.keywords.discard)?e=new is:this._match(o.keywords.break)?e=new as:this._match(o.keywords.continue)?e=new os:e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),e!=null&&this._consume(o.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(o.keywords.static_assert))return null;let e=this._optional_paren_expression();return new Xr(e)}_while_statement(){if(!this._match(o.keywords.while))return null;let e=this._optional_paren_expression();const n=this._compound_statement();return new Yr(e,n)}_continuing_statement(){if(!this._match(o.keywords.continuing))return null;const e=this._compound_statement();return new Kr(e)}_for_statement(){if(!this._match(o.keywords.for))return null;this._consume(o.tokens.paren_left,"Expected '('.");const e=this._check(o.tokens.semicolon)?null:this._for_init();this._consume(o.tokens.semicolon,"Expected ';'.");const n=this._check(o.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(o.tokens.semicolon,"Expected ';'.");const r=this._check(o.tokens.paren_right)?null:this._for_increment();this._consume(o.tokens.paren_right,"Expected ')'.");const s=this._compound_statement();return new Wr(e,n,r,s)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(o.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let n=null;return this._match(o.tokens.equal)&&(n=this._short_circuit_or_expression()),new Ae(e.name,e.type,e.storage,e.access,n)}if(this._match(o.keywords.let)){const e=this._consume(o.tokens.ident,"Expected name for let.").toString();let n=null;if(this._match(o.tokens.colon)){const s=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=s)}this._consume(o.tokens.equal,"Expected '=' for let.");const r=this._short_circuit_or_expression();return new Lt(e,n,null,null,r)}if(this._match(o.keywords.const)){const e=this._consume(o.tokens.ident,"Expected name for const.").toString();let n=null;if(this._match(o.tokens.colon)){const s=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=s)}this._consume(o.tokens.equal,"Expected '=' for const.");const r=this._short_circuit_or_expression();return new An(e,n,null,null,r)}return null}_increment_decrement_statement(){const e=this._current,n=this._unary_expression();if(n==null)return null;if(!this._check(o.increment_operators))return this._current=e,null;const r=this._consume(o.increment_operators,"Expected increment operator");return new Zr(r.type===o.tokens.plus_plus?Fe.increment:Fe.decrement,n)}_assignment_statement(){let e=null;if(this._check(o.tokens.brace_right))return null;let n=this._match(o.tokens.underscore);if(n||(e=this._unary_expression()),!n&&e==null)return null;const r=this._consume(o.assignment_operators,"Expected assignment operator."),s=this._short_circuit_or_expression();return new Jr(Je.parse(r.lexeme),e,s)}_func_call_statement(){if(!this._check(o.tokens.ident))return null;const e=this._current,n=this._consume(o.tokens.ident,"Expected function name."),r=this._argument_expression_list();return r===null?(this._current=e,null):new Qr(n.lexeme,r)}_loop_statement(){if(!this._match(o.keywords.loop))return null;this._consume(o.tokens.brace_left,"Expected '{' for loop.");const e=[];let n=this._statement();for(;n!==null;){if(Array.isArray(n))for(let s of n)e.push(s);else e.push(n);n=this._statement()}let r=null;return this._match(o.keywords.continuing)&&(r=this._compound_statement()),this._consume(o.tokens.brace_right,"Expected '}' for loop."),new es(e,r)}_switch_statement(){if(!this._match(o.keywords.switch))return null;const e=this._optional_paren_expression();this._consume(o.tokens.brace_left,"Expected '{' for switch.");const n=this._switch_body();if(n==null||n.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(o.tokens.brace_right,"Expected '}' for switch."),new ts(e,n)}_switch_body(){const e=[];if(this._match(o.keywords.case)){const n=this._case_selectors();this._match(o.tokens.colon),this._consume(o.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(o.tokens.brace_right,"Exected '}' for switch case."),e.push(new ds(n,r))}if(this._match(o.keywords.default)){this._match(o.tokens.colon),this._consume(o.tokens.brace_left,"Exected '{' for switch default.");const n=this._case_body();this._consume(o.tokens.brace_right,"Exected '}' for switch default."),e.push(new _s(n))}if(this._check([o.keywords.default,o.keywords.case])){const n=this._switch_body();e.push(n[0])}return e}_case_selectors(){var e,n,r,s;const i=[(n=(e=this._shift_expression())===null||e===void 0?void 0:e.evaluate(this._context).toString())!==null&&n!==void 0?n:""];for(;this._match(o.tokens.comma);)i.push((s=(r=this._shift_expression())===null||r===void 0?void 0:r.evaluate(this._context).toString())!==null&&s!==void 0?s:"");return i}_case_body(){if(this._match(o.keywords.fallthrough))return this._consume(o.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const n=this._case_body();return n.length==0?e:[...e,n[0]]}_if_statement(){if(!this._match(o.keywords.if))return null;const e=this._optional_paren_expression(),n=this._compound_statement();let r=[];this._match_elseif()&&(r=this._elseif_statement(r));let s=null;return this._match(o.keywords.else)&&(s=this._compound_statement()),new ns(e,n,r,s)}_match_elseif(){return this._tokens[this._current].type===o.keywords.else&&this._tokens[this._current+1].type===o.keywords.if?(this._advance(),this._advance(),!0):!1}_elseif_statement(e=[]){const n=this._optional_paren_expression(),r=this._compound_statement();return e.push(new fs(n,r)),this._match_elseif()&&this._elseif_statement(e),e}_return_statement(){if(!this._match(o.keywords.return))return null;const e=this._short_circuit_or_expression();return new rs(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(o.tokens.or_or);)e=new de(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(o.tokens.and_and);)e=new de(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(o.tokens.or);)e=new de(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(o.tokens.xor);)e=new de(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(o.tokens.and);)e=new de(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([o.tokens.equal_equal,o.tokens.not_equal])?new de(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([o.tokens.less_than,o.tokens.greater_than,o.tokens.less_than_equal,o.tokens.greater_than_equal]);)e=new de(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([o.tokens.shift_left,o.tokens.shift_right]);)e=new de(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([o.tokens.plus,o.tokens.minus]);)e=new de(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([o.tokens.star,o.tokens.forward_slash,o.tokens.modulo]);)e=new de(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([o.tokens.minus,o.tokens.bang,o.tokens.tilde,o.tokens.star,o.tokens.and])?new hs(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),n=this._postfix_expression();return n&&(e.postfix=n),e}_postfix_expression(){if(this._match(o.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(o.tokens.bracket_right,"Expected ']'.");const n=this._postfix_expression();return n&&(e.postfix=n),e}if(this._match(o.tokens.period)){const e=this._consume(o.tokens.ident,"Expected member name."),n=this._postfix_expression(),r=new Cn(e.lexeme);return n&&(r.postfix=n),r}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_primary_expression(){if(this._match(o.tokens.ident)){const r=this._previous().toString();if(this._check(o.tokens.paren_left)){const s=this._argument_expression_list(),i=this._getStruct(r);return i!=null?new et(i,s):new Nn(r,s)}if(this._context.constants.has(r)){const s=this._context.constants.get(r);return new On(r,s.value)}return new Rn(r)}if(this._match(o.const_literal))return new Bn(parseFloat(this._previous().toString()));if(this._check(o.tokens.paren_left))return this._paren_expression();if(this._match(o.keywords.bitcast)){this._consume(o.tokens.less_than,"Expected '<'.");const r=this._type_decl();this._consume(o.tokens.greater_than,"Expected '>'.");const s=this._paren_expression();return new cs(r,s)}const e=this._type_decl(),n=this._argument_expression_list();return new ls(e,n)}_argument_expression_list(){if(!this._match(o.tokens.paren_left))return null;const e=[];do{if(this._check(o.tokens.paren_right))break;const n=this._short_circuit_or_expression();e.push(n)}while(this._match(o.tokens.comma));return this._consume(o.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(o.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(o.tokens.paren_right),new Dn([e])}_paren_expression(){this._consume(o.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(o.tokens.paren_right,"Expected ')'."),new Dn([e])}_struct_decl(){if(!this._match(o.keywords.struct))return null;const e=this._consume(o.tokens.ident,"Expected name for struct.").toString();this._consume(o.tokens.brace_left,"Expected '{' for struct body.");const n=[];for(;!this._check(o.tokens.brace_right);){const s=this._attribute(),i=this._consume(o.tokens.ident,"Expected variable name.").toString();this._consume(o.tokens.colon,"Expected ':' for struct member type.");const a=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=a),this._check(o.tokens.brace_right)?this._match(o.tokens.comma):this._consume(o.tokens.comma,"Expected ',' for struct member."),n.push(new ms(i,u,s))}this._consume(o.tokens.brace_right,"Expected '}' after struct body.");const r=new Te(e,n);return this._context.structs.set(e,r),r}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(o.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(o.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(o.keywords.const))return null;const e=this._consume(o.tokens.ident,"Expected variable name");let n=null;if(this._match(o.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}let r=null;if(this._match(o.tokens.equal)){const i=this._short_circuit_or_expression();if(i instanceof et)r=i;else if(i instanceof On&&i.initializer instanceof et)r=i.initializer;else try{const a=i.evaluate(this._context);r=new Bn(a)}catch{r=i}}const s=new An(e.toString(),n,"","",r);return this._context.constants.set(s.name,s),s}_global_let_decl(){if(!this._match(o.keywords.let))return null;const e=this._consume(o.tokens.ident,"Expected variable name");let n=null;if(this._match(o.tokens.colon)){const s=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=s)}let r=null;return this._match(o.tokens.equal)&&(r=this._const_expression()),new Lt(e.toString(),n,"","",r)}_const_expression(){if(this._match(o.const_literal))return new Cn(this._previous().toString());const e=this._type_decl();this._consume(o.tokens.paren_left,"Expected '('.");let n=[];for(;!this._check(o.tokens.paren_right)&&(n.push(this._const_expression()),!!this._check(o.tokens.comma));)this._advance();return this._consume(o.tokens.paren_right,"Expected ')'."),new et(e,n)}_variable_decl(){if(!this._match(o.keywords.var))return null;let e="",n="";this._match(o.tokens.less_than)&&(e=this._consume(o.storage_class,"Expected storage_class.").toString(),this._match(o.tokens.comma)&&(n=this._consume(o.access_mode,"Expected access_mode.").toString()),this._consume(o.tokens.greater_than,"Expected '>'."));const r=this._consume(o.tokens.ident,"Expected variable name");let s=null;if(this._match(o.tokens.colon)){const i=this._attribute();s=this._type_decl(),s!=null&&(s.attributes=i)}return new Ae(r.toString(),s,e,n,null)}_override_decl(){if(!this._match(o.keywords.override))return null;const e=this._consume(o.tokens.ident,"Expected variable name");let n=null;if(this._match(o.tokens.colon)){const r=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=r)}return new Sn(e.toString(),n,null)}_enable_directive(){const e=this._consume(o.tokens.ident,"identity expected.");return new ss(e.toString())}_type_alias(){const e=this._consume(o.tokens.ident,"identity expected.");this._consume(o.tokens.equal,"Expected '=' for type alias.");let n=this._type_decl();if(n===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(n.name)&&(n=this._context.aliases.get(n.name).type);const r=new Mn(e.toString(),n);return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([o.tokens.ident,...o.texel_format,o.keywords.bool,o.keywords.f32,o.keywords.i32,o.keywords.u32])){const r=this._advance(),s=r.toString();return this._context.structs.has(s)?this._context.structs.get(s):this._context.aliases.has(s)?this._context.aliases.get(s).type:new Me(r.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(o.template_types)){let r=this._advance().toString(),s=null,i=null;return this._match(o.tokens.less_than)&&(s=this._type_decl(),i=null,this._match(o.tokens.comma)&&(i=this._consume(o.access_mode,"Expected access_mode for pointer").toString()),this._consume(o.tokens.greater_than,"Expected '>' for type.")),new Tn(r,s,i)}if(this._match(o.keywords.ptr)){let r=this._previous().toString();this._consume(o.tokens.less_than,"Expected '<' for pointer.");const s=this._consume(o.storage_class,"Expected storage_class for pointer");this._consume(o.tokens.comma,"Expected ',' for pointer.");const i=this._type_decl();let a=null;return this._match(o.tokens.comma)&&(a=this._consume(o.access_mode,"Expected access_mode for pointer").toString()),this._consume(o.tokens.greater_than,"Expected '>' for pointer."),new us(r,s.toString(),i,a)}const n=this._attribute();if(this._match(o.keywords.array)){let r=null,s=-1;const i=this._previous();if(this._match(o.tokens.less_than)){r=this._type_decl(),this._context.aliases.has(r.name)&&(r=this._context.aliases.get(r.name).type);let a="";this._match(o.tokens.comma)&&(a=this._shift_expression().evaluate(this._context).toString()),this._consume(o.tokens.greater_than,"Expected '>' for array."),s=a?parseInt(a):0}return new In(i.toString(),n,r,s)}return null}_texture_sampler_types(){if(this._match(o.sampler_type))return new Qe(this._previous().toString(),null,null);if(this._match(o.depth_texture_type))return new Qe(this._previous().toString(),null,null);if(this._match(o.sampled_texture_type)||this._match(o.multisampled_texture_type)){const e=this._previous();this._consume(o.tokens.less_than,"Expected '<' for sampler type.");const n=this._type_decl();return this._consume(o.tokens.greater_than,"Expected '>' for sampler type."),new Qe(e.toString(),n,null)}if(this._match(o.storage_texture_type)){const e=this._previous();this._consume(o.tokens.less_than,"Expected '<' for sampler type.");const n=this._consume(o.texel_format,"Invalid texel format.").toString();this._consume(o.tokens.comma,"Expected ',' after texel format.");const r=this._consume(o.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(o.tokens.greater_than,"Expected '>' for sampler type."),new Qe(e.toString(),n,r)}return null}_attribute(){let e=[];for(;this._match(o.tokens.attr);){const n=this._consume(o.attribute_name,"Expected attribute name"),r=new Fn(n.toString(),null);if(this._match(o.tokens.paren_left)){if(r.value=this._consume(o.literal_or_ident,"Expected attribute value").toString(),this._check(o.tokens.comma)){this._advance();do{const s=this._consume(o.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(s)}while(this._match(o.tokens.comma))}this._consume(o.tokens.paren_right,"Expected ')'")}e.push(r)}for(;this._match(o.tokens.attr_left);){if(!this._check(o.tokens.attr_right))do{const n=this._consume(o.attribute_name,"Expected attribute name"),r=new Fn(n.toString(),null);if(this._match(o.tokens.paren_left)){if(r.value=[this._consume(o.literal_or_ident,"Expected attribute value").toString()],this._check(o.tokens.comma)){this._advance();do{const s=this._consume(o.literal_or_ident,"Expected attribute value").toString();r.value.push(s)}while(this._match(o.tokens.comma))}this._consume(o.tokens.paren_right,"Expected ')'")}e.push(r)}while(this._match(o.tokens.comma));this._consume(o.tokens.attr_right,"Expected ']]' after attribute declarations")}return e.length==0?null:e}}class ze{constructor(e,n){this.name=e,this.attributes=n,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class Pn{constructor(e,n,r){this.name=e,this.type=n,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class ct extends ze{constructor(e,n){super(e,n),this.members=[],this.align=0}get isStruct(){return!0}}class Ut extends ze{constructor(e,n){super(e,n),this.count=0,this.stride=0}get isArray(){return!0}}class Vn extends ze{constructor(e,n,r,s){super(e,r),this.format=n,this.access=s}get isTemplate(){return!0}}var re;(function(t){t[t.Uniform=0]="Uniform",t[t.Storage=1]="Storage",t[t.Texture=2]="Texture",t[t.Sampler=3]="Sampler",t[t.StorageTexture=4]="StorageTexture"})(re||(re={}));class lt{constructor(e,n,r,s,i,a,u){this.name=e,this.type=n,this.group=r,this.binding=s,this.attributes=i,this.resourceType=a,this.access=u}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray?this.type.format:this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class vs{constructor(e,n){this.name=e,this.type=n}}class ht{constructor(e,n){this.align=e,this.size=n}}class bs{constructor(e,n,r,s){this.name=e,this.type=n,this.locationType=r,this.location=s,this.interpolation=null}}class $n{constructor(e,n,r,s){this.name=e,this.type=n,this.locationType=r,this.location=s}}class xs{constructor(e,n=null){this.stage=null,this.inputs=[],this.outputs=[],this.resources=[],this.name=e,this.stage=n}}class ws{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class ks{constructor(e,n,r,s){this.name=e,this.type=n,this.attributes=r,this.id=s}}class Es{constructor(e){this.resources=null,this.node=e}}class fe{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new ws,this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}update(e){const n=new ys().parse(e);for(const r of n)r instanceof Dt&&this._functions.set(r.name,new Es(r));for(const r of n){if(r instanceof Te){const s=this._getTypeInfo(r,null);s instanceof ct&&this.structs.push(s);continue}if(r instanceof Mn){this.aliases.push(this._getAliasInfo(r));continue}if(r instanceof Sn){const s=r,i=this._getAttributeNum(s.attributes,"id",0),a=s.type!=null?this._getTypeInfo(s.type,s.attributes):null;this.overrides.push(new ks(s.name,a,s.attributes,i));continue}if(this._isUniformVar(r)){const s=r,i=this._getAttributeNum(s.attributes,"group",0),a=this._getAttributeNum(s.attributes,"binding",0),u=this._getTypeInfo(s.type,s.attributes),d=new lt(s.name,u,i,a,s.attributes,re.Uniform,s.access);this.uniforms.push(d);continue}if(this._isStorageVar(r)){const s=r,i=this._getAttributeNum(s.attributes,"group",0),a=this._getAttributeNum(s.attributes,"binding",0),u=this._getTypeInfo(s.type,s.attributes),d=this._isStorageTexture(u),m=new lt(s.name,u,i,a,s.attributes,d?re.StorageTexture:re.Storage,s.access);this.storage.push(m);continue}if(this._isTextureVar(r)){const s=r,i=this._getAttributeNum(s.attributes,"group",0),a=this._getAttributeNum(s.attributes,"binding",0),u=this._getTypeInfo(s.type,s.attributes),d=this._isStorageTexture(u),m=new lt(s.name,u,i,a,s.attributes,d?re.StorageTexture:re.Texture,s.access);d?this.storage.push(m):this.textures.push(m);continue}if(this._isSamplerVar(r)){const s=r,i=this._getAttributeNum(s.attributes,"group",0),a=this._getAttributeNum(s.attributes,"binding",0),u=this._getTypeInfo(s.type,s.attributes),d=new lt(s.name,u,i,a,s.attributes,re.Sampler,s.access);this.samplers.push(d);continue}if(r instanceof Dt){const s=this._getAttribute(r,"vertex"),i=this._getAttribute(r,"fragment"),a=this._getAttribute(r,"compute"),u=s||i||a;if(u){const d=new xs(r.name,u==null?void 0:u.name);d.inputs=this._getInputs(r.args),d.outputs=this._getOutputs(r.returnType),d.resources=this._findResources(r),this.entry[u.name].push(d)}continue}}}_findResource(e){for(const n of this.uniforms)if(n.name==e)return n;for(const n of this.storage)if(n.name==e)return n;for(const n of this.textures)if(n.name==e)return n;for(const n of this.samplers)if(n.name==e)return n;return null}_findResources(e){const n=[],r=this,s=[];return e.search(i=>{if(i instanceof ot)s.push({});else if(i instanceof ut)s.pop();else if(i instanceof Ae){if(s.length>0){const a=i;s[s.length-1][a.name]=a}}else if(i instanceof Lt){if(s.length>0){const a=i;s[s.length-1][a.name]=a}}else if(i instanceof Rn){const a=i;if(s.length>0&&s[s.length-1][a.name])return;const u=r._findResource(a.name);u&&n.push(u)}else if(i instanceof Nn){const a=i,u=r._functions.get(a.name);u&&(u.resources===null&&(u.resources=r._findResources(u.node)),n.push(...u.resources))}}),[...new Map(n.map(i=>[i.name,i])).values()]}getBindGroups(){const e=[];function n(r,s){r>=e.length&&(e.length=r+1),e[r]===void 0&&(e[r]=[]),s>=e[r].length&&(e[r].length=s+1)}for(const r of this.uniforms){n(r.group,r.binding);const s=e[r.group];s[r.binding]=r}for(const r of this.storage){n(r.group,r.binding);const s=e[r.group];s[r.binding]=r}for(const r of this.textures){n(r.group,r.binding);const s=e[r.group];s[r.binding]=r}for(const r of this.samplers){n(r.group,r.binding);const s=e[r.group];s[r.binding]=r}return e}_getOutputs(e,n=void 0){if(n===void 0&&(n=[]),e instanceof Te)this._getStructOutputs(e,n);else{const r=this._getOutputInfo(e);r!==null&&n.push(r)}return n}_getStructOutputs(e,n){for(const r of e.members)if(r.type instanceof Te)this._getStructOutputs(r.type,n);else{const s=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(s!==null){const i=this._getTypeInfo(r.type,r.type.attributes),a=this._parseInt(s.value),u=new $n(r.name,i,s.name,a);n.push(u)}}}_getOutputInfo(e){const n=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(n!==null){const r=this._getTypeInfo(e,e.attributes),s=this._parseInt(n.value);return new $n("",r,n.name,s)}return null}_getInputs(e,n=void 0){n===void 0&&(n=[]);for(const r of e)if(r.type instanceof Te)this._getStructInputs(r.type,n);else{const s=this._getInputInfo(r);s!==null&&n.push(s)}return n}_getStructInputs(e,n){for(const r of e.members)if(r.type instanceof Te)this._getStructInputs(r.type,n);else{const s=this._getInputInfo(r);s!==null&&n.push(s)}}_getInputInfo(e){const n=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(n!==null){const r=this._getAttribute(e,"interpolation"),s=this._getTypeInfo(e.type,e.attributes),i=this._parseInt(n.value),a=new bs(e.name,s,n.name,i);return r!==null&&(a.interpolation=this._parseString(r.value)),a}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const n=parseInt(e);return isNaN(n)?e:n}_getAlias(e){for(const n of this.aliases)if(n.name==e)return n.type;return null}_getAliasInfo(e){return new vs(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,n){if(this._types.has(e))return this._types.get(e);if(e instanceof In){const s=e,i=this._getTypeInfo(s.format,s.attributes),a=new Ut(s.name,n);return a.format=i,a.count=s.count,this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof Te){const s=e,i=new ct(s.name,n);for(const a of s.members){const u=this._getTypeInfo(a.type,a.attributes);i.members.push(new Pn(a.name,u,a.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Qe){const s=e,i=s.format instanceof Me,a=s.format?i?this._getTypeInfo(s.format,null):new ze(s.format,null):null,u=new Vn(s.name,a,n,s.access);return this._types.set(e,u),this._updateTypeInfo(u),u}if(e instanceof Tn){const s=e,i=s.format?this._getTypeInfo(s.format,null):null,a=new Vn(s.name,i,n,s.access);return this._types.set(e,a),this._updateTypeInfo(a),a}const r=new ze(e.name,n);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var n,r;const s=this._getTypeSize(e);if(e.size=(n=s==null?void 0:s.size)!==null&&n!==void 0?n:0,e instanceof Ut){const i=this._getTypeSize(e.format);e.stride=(r=i==null?void 0:i.size)!==null&&r!==void 0?r:0,this._updateTypeInfo(e.format)}e instanceof ct&&this._updateStructInfo(e)}_updateStructInfo(e){var n;let r=0,s=0,i=0,a=0;for(let u=0,d=e.members.length;u<d;++u){const m=e.members[u],v=this._getTypeSize(m);if(!v)continue;(n=this._getAlias(m.type.name))!==null&&n!==void 0||m.type;const h=v.align,p=v.size;r=this._roundUp(h,r+s),s=p,i=r,a=Math.max(a,h),m.offset=r,m.size=p,this._updateTypeInfo(m.type)}e.size=this._roundUp(a,i+s),e.align=a}_getTypeSize(e){var n;if(e==null)return null;const r=this._getAttributeNum(e.attributes,"size",0),s=this._getAttributeNum(e.attributes,"align",0);if(e instanceof Pn&&(e=e.type),e instanceof ze){const i=this._getAlias(e.name);i!==null&&(e=i)}{const i=fe._typeInfo[e.name];if(i!==void 0){const a=e.format==="f16"?2:1;return new ht(Math.max(s,i.align/a),Math.max(r,i.size/a))}}{const i=fe._typeInfo[e.name.substring(0,e.name.length-1)];if(i){const a=e.name[e.name.length-1]==="h"?2:1;return new ht(Math.max(s,i.align/a),Math.max(r,i.size/a))}}if(e instanceof Ut){let i=e,a=8,u=8;const d=this._getTypeSize(i.format);d!==null&&(u=d.size,a=d.align);const m=i.count,v=this._getAttributeNum((n=e==null?void 0:e.attributes)!==null&&n!==void 0?n:null,"stride",this._roundUp(a,u));return u=m*v,r&&(u=r),new ht(Math.max(s,a),Math.max(r,u))}if(e instanceof ct){let i=0,a=0,u=0,d=0,m=0;for(const v of e.members){const h=this._getTypeSize(v.type);h!==null&&(i=Math.max(h.align,i),u=this._roundUp(h.align,u+d),d=h.size,m=u)}return a=this._roundUp(i,m+d),new ht(Math.max(s,i),Math.max(r,a))}return null}_isUniformVar(e){return e instanceof Ae&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Ae&&e.storage=="storage"}_isTextureVar(e){return e instanceof Ae&&e.type!==null&&fe._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Ae&&e.type!==null&&fe._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,n){const r=e;if(!r||!r.attributes)return null;const s=r.attributes;for(let i of s)if(i.name==n)return i;return null}_getAttributeNum(e,n,r){if(e===null)return r;for(let s of e)if(s.name==n){let i=s!==null&&s.value!==null?s.value:r;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):r}return r}_roundUp(e,n){return Math.ceil(n/e)*e}}fe._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},fe._textureTypes=o.any_texture_type.map(t=>t.name),fe._samplerTypes=o.sampler_type.map(t=>t.name);function Gn(t,e){return Object.fromEntries(e.map(n=>{const r=Pt(t,n.type,0);return[n.name,{typeDefinition:r,group:n.group,binding:n.binding,size:r.size}]}))}function Hn(t,e,n){return{fields:Object.fromEntries(e.members.map(r=>[r.name,{offset:r.offset,type:Pt(t,r.type,0)}])),size:e.size,offset:n}}function Ss(t){var e;if(t.name.includes("depth"))return"depth";switch((e=t.format)==null?void 0:e.name){case"f32":return"float";case"i32":return"sint";case"u32":return"uint";default:throw new Error("unknown texture sample type")}}function jn(t){return t.name.includes("2d_array")?"2d-array":t.name.includes("cube_array")?"cube-array":t.name.includes("3d")?"3d":t.name.includes("1d")?"1d":t.name.includes("cube")?"cube":"2d"}function As(t){switch(t.access){case"read":return"read-only";case"write":return"write-only";case"read_write":return"read-write";default:throw new Error("unknonw storage texture access")}}function Ms(t){return t.name.endsWith("_comparison")?"comparison":"filtering"}function Ts(t,e){const{binding:n,access:r,type:s}=t;switch(t.resourceType){case re.Uniform:return{binding:n,visibility:e,buffer:{}};case re.Storage:return{binding:n,visibility:e,buffer:{type:r===""||r==="read"?"read-only-storage":"storage"}};case re.Texture:{if(s.name==="texture_external")return{binding:n,visibility:e,externalTexture:{}};const i=s.name.includes("multisampled");return{binding:n,visibility:e,texture:{sampleType:Ss(s),viewDimension:jn(s),multisampled:i}}}case re.Sampler:return{binding:n,visibility:e,sampler:{type:Ms(s)}};case re.StorageTexture:return{binding:n,visibility:e,storageTexture:{access:As(s),format:s.format.name,viewDimension:jn(s)}};default:throw new Error("unknown resource type")}}function Ft(t,e){const n={};for(const r of t)n[r.name]={stage:e,resources:r.resources.map(s=>{const{name:i,group:a}=s;return{name:i,group:a,entry:Ts(s,e)}})};return n}function qn(t){const e=new fe(t),n=Object.fromEntries(e.structs.map(a=>[a.name,Hn(e,a,0)])),r=Gn(e,e.uniforms),s=Gn(e,e.storage),i={...Ft(e.entry.vertex,GPUShaderStage.VERTEX),...Ft(e.entry.fragment,GPUShaderStage.FRAGMENT),...Ft(e.entry.compute,GPUShaderStage.COMPUTE)};return{structs:n,storages:s,uniforms:r,entryPoints:i}}function zt(t,e=""){if(!t)throw new Error(e)}function Pt(t,e,n){if(e.isArray){zt(!e.isStruct,"struct array is invalid"),zt(!e.isStruct,"template array is invalid");const r=e;return{size:r.size,elementType:Pt(t,r.format,n),numElements:r.count}}else{if(e.isStruct)return zt(!e.isTemplate,"template struct is invalid"),Hn(t,e,n);{const r=e,s=e.isTemplate?`${r.name}<${r.format.name}>`:e.name;return{size:e.size,type:s}}}}const Is=new Map([[Int8Array,{formats:["sint8","snorm8"],defaultForType:1}],[Uint8Array,{formats:["uint8","unorm8"],defaultForType:1}],[Int16Array,{formats:["sint16","snorm16"],defaultForType:1}],[Uint16Array,{formats:["uint16","unorm16"],defaultForType:1}],[Int32Array,{formats:["sint32","snorm32"],defaultForType:0}],[Uint32Array,{formats:["uint32","unorm32"],defaultForType:0}],[Float32Array,{formats:["float32","float32"],defaultForType:0}]]);new Map([...Is.entries()].map(([t,{formats:[e,n]}])=>[[e,t],[n,t]]).flat());var Vt=1e-6,me=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function $t(){var t=new me(16);return me!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Cs(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ns(t,e,n){var r=e[0],s=e[1],i=e[2],a=e[3],u=e[4],d=e[5],m=e[6],v=e[7],h=e[8],p=e[9],y=e[10],S=e[11],b=e[12],F=e[13],I=e[14],Y=e[15],R=n[0],U=n[1],O=n[2],A=n[3];return t[0]=R*r+U*u+O*h+A*b,t[1]=R*s+U*d+O*p+A*F,t[2]=R*i+U*m+O*y+A*I,t[3]=R*a+U*v+O*S+A*Y,R=n[4],U=n[5],O=n[6],A=n[7],t[4]=R*r+U*u+O*h+A*b,t[5]=R*s+U*d+O*p+A*F,t[6]=R*i+U*m+O*y+A*I,t[7]=R*a+U*v+O*S+A*Y,R=n[8],U=n[9],O=n[10],A=n[11],t[8]=R*r+U*u+O*h+A*b,t[9]=R*s+U*d+O*p+A*F,t[10]=R*i+U*m+O*y+A*I,t[11]=R*a+U*v+O*S+A*Y,R=n[12],U=n[13],O=n[14],A=n[15],t[12]=R*r+U*u+O*h+A*b,t[13]=R*s+U*d+O*p+A*F,t[14]=R*i+U*m+O*y+A*I,t[15]=R*a+U*v+O*S+A*Y,t}function Rs(t,e,n,r,s){var i=1/Math.tan(e/2),a;return t[0]=i/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,s!=null&&s!==1/0?(a=1/(r-s),t[10]=(s+r)*a,t[14]=2*s*r*a):(t[10]=-1,t[14]=-2*r),t}var Os=Rs;function Bs(t,e,n,r){var s,i,a,u,d,m,v,h,p,y,S=e[0],b=e[1],F=e[2],I=r[0],Y=r[1],R=r[2],U=n[0],O=n[1],A=n[2];return Math.abs(S-U)<Vt&&Math.abs(b-O)<Vt&&Math.abs(F-A)<Vt?Cs(t):(v=S-U,h=b-O,p=F-A,y=1/Math.hypot(v,h,p),v*=y,h*=y,p*=y,s=Y*p-R*h,i=R*v-I*p,a=I*h-Y*v,y=Math.hypot(s,i,a),y?(y=1/y,s*=y,i*=y,a*=y):(s=0,i=0,a=0),u=h*a-p*i,d=p*s-v*a,m=v*i-h*s,y=Math.hypot(u,d,m),y?(y=1/y,u*=y,d*=y,m*=y):(u=0,d=0,m=0),t[0]=s,t[1]=u,t[2]=v,t[3]=0,t[4]=i,t[5]=d,t[6]=h,t[7]=0,t[8]=a,t[9]=m,t[10]=p,t[11]=0,t[12]=-(s*S+i*b+a*F),t[13]=-(u*S+d*b+m*F),t[14]=-(v*S+h*b+p*F),t[15]=1,t)}var Ds=Ns;function Pe(){var t=new me(3);return me!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ls(t){var e=new me(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Us(t){var e=t[0],n=t[1],r=t[2];return Math.hypot(e,n,r)}function ce(t,e,n){var r=new me(3);return r[0]=t,r[1]=e,r[2]=n,r}function Xn(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function Fs(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function Yn(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function Kn(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function zs(t,e){var n=e[0]-t[0],r=e[1]-t[1],s=e[2]-t[2];return Math.hypot(n,r,s)}function Ps(t,e){var n=e[0],r=e[1],s=e[2],i=n*n+r*r+s*s;return i>0&&(i=1/Math.sqrt(i)),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function Vs(t,e,n){var r=e[0],s=e[1],i=e[2],a=n[0],u=n[1],d=n[2];return t[0]=s*d-i*u,t[1]=i*a-r*d,t[2]=r*u-s*a,t}var Wn=Yn;(function(){var t=Pe();return function(e,n,r,s,i,a){var u,d;for(n||(n=3),r||(r=0),s?d=Math.min(s*n+r,e.length):d=e.length,u=r;u<d;u+=n)t[0]=e[u],t[1]=e[u+1],t[2]=e[u+2],i(t,t,a),e[u]=t[0],e[u+1]=t[1],e[u+2]=t[2];return e}})();function $s(){var t=new me(4);return me!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function Ie(t,e,n,r){var s=new me(4);return s[0]=t,s[1]=e,s[2]=n,s[3]=r,s}(function(){var t=$s();return function(e,n,r,s,i,a){var u,d;for(n||(n=4),r||(r=0),s?d=Math.min(s*n+r,e.length):d=e.length,u=r;u<d;u+=n)t[0]=e[u],t[1]=e[u+1],t[2]=e[u+2],t[3]=e[u+3],i(t,t,a),e[u]=t[0],e[u+1]=t[1],e[u+2]=t[2],e[u+3]=t[3];return e}})();const dt=(t,e=0,n=1)=>Math.min(Math.max(t,e),n);class Ve{constructor(){this.value=0,this.damping=.5}addForce(e){this.value+=e}update(){return this.value*this.value>1e-6?this.value*=this.damping:this.stop(),this.value}stop(){this.value=0}}const vt=class vt{constructor(e,n,r,s){this.domElement=e,this.position=n,this.vfov=r,this.aspectRatio=s,this.target=ce(0,0,-1),this.viewProjectionMatrix=$t(),this.viewMatrix=$t(),this.projectionMatrix=$t(),this.viewportWidth=innerWidth,this.viewportHeight=innerHeight,this.state="rotate",this.fov=45,this.rotateDelta={x:0,y:0},this.rotateStart={x:0,y:0},this.rotateEnd={x:0,y:0},this.panStart={x:0,y:0},this.panDelta={x:0,y:0},this.panEnd={x:0,y:0},this.touchStartDistance=0,this.touchEndDistance=0,this.spherical={radius:0,theta:0,phi:0},this.minDistance=.1,this.maxDistance=100,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.targetXDampedAction=new Ve,this.targetYDampedAction=new Ve,this.targetZDampedAction=new Ve,this.targetThetaDampedAction=new Ve,this.targetPhiDampedAction=new Ve,this.targetRadiusDampedAction=new Ve,this.rotateSpeed=1,this.panSpeed=.5,this.zoomSpeed=2,this.onResize=()=>{this.viewportWidth=innerWidth,this.viewportHeight=innerHeight,this.aspectRatio=this.viewportWidth/this.viewportHeight},this.onTouchStart=i=>{if(i.preventDefault(),i.touches.length===1)this.state="rotate",this.rotateStart.x=i.touches[0].pageX,this.rotateStart.y=i.touches[0].pageY;else if(i.touches.length===2){const a=i.touches[0],u=i.touches[1];this.touchStartDistance=Math.sqrt(Math.pow(u.pageX-a.pageX,2)+Math.pow(u.pageY-a.pageY,2)),this.panStart.x=a.pageX,this.panStart.y=a.pageY}this.domElement.addEventListener("touchmove",this.onTouchMove)},this.onTouchEnd=i=>{i.preventDefault(),this.domElement.removeEventListener("touchmove",this.onTouchMove)},this.onTouchMove=i=>{if(i.preventDefault(),i.touches.length===1&&this.state==="rotate")this.rotateEnd.x=i.touches[0].pageX,this.rotateEnd.y=i.touches[0].pageY,this.rotateDelta.x=(this.rotateEnd.x-this.rotateStart.x)*this.rotateSpeed,this.rotateDelta.y=(this.rotateEnd.y-this.rotateStart.y)*this.rotateSpeed,this.targetThetaDampedAction.addForce(-this.rotateDelta.x/this.viewportWidth),this.targetPhiDampedAction.addForce(-this.rotateDelta.y/this.viewportHeight),this.rotateStart.x=this.rotateEnd.x,this.rotateStart.y=this.rotateEnd.y;else if(i.touches.length===2){const a=i.touches[0],u=i.touches[1];if(this.touchEndDistance=Math.sqrt(Math.pow(u.pageX-a.pageX,2)+Math.pow(u.pageY-a.pageY,2)),this.touchStartDistance>0){const v=(this.touchEndDistance-this.touchStartDistance)/this.viewportHeight;this.targetRadiusDampedAction.addForce(-v*this.zoomSpeed*3),this.touchStartDistance=this.touchEndDistance}const d=(a.pageX+u.pageX)/2,m=(a.pageY+u.pageY)/2;this.panDelta.x=(d-this.panStart.x)*this.panSpeed,this.panDelta.y=(m-this.panStart.y)*this.panSpeed,(Math.abs(this.panDelta.x)>1||Math.abs(this.panDelta.y)>1)&&this.pan(this.panDelta.x,this.panDelta.y),this.panStart.x=d,this.panStart.y=m}},this.onMouseDown=i=>{i.button===0?(this.state="rotate",this.rotateStart.x=i.pageX,this.rotateStart.y=i.pageY):i.button===2&&(this.state="pan",this.panStart.x=i.pageX,this.panStart.y=i.pageY),this.domElement.addEventListener("mousemove",this.onMouseMove)},this.onMouseMove=i=>{this.state==="rotate"?(this.rotateEnd.x=i.pageX,this.rotateEnd.y=i.pageY,this.rotateDelta.x=(this.rotateEnd.x-this.rotateStart.x)*this.rotateSpeed,this.rotateDelta.y=(this.rotateEnd.y-this.rotateStart.y)*this.rotateSpeed,this.targetThetaDampedAction.addForce(-this.rotateDelta.x/this.viewportWidth),this.targetPhiDampedAction.addForce(-this.rotateDelta.y/this.viewportHeight),this.rotateStart.x=this.rotateEnd.x,this.rotateStart.y=this.rotateEnd.y):this.state==="pan"&&(this.panEnd.x=i.pageX,this.panEnd.y=i.pageY,this.panDelta.x=(this.panEnd.x-this.panStart.x)*this.panSpeed,this.panDelta.y=(this.panEnd.y-this.panStart.y)*this.panSpeed,this.pan(this.panDelta.x,this.panDelta.y),this.panStart.x=this.panEnd.x,this.panStart.y=this.panEnd.y)},this.onMouseUp=i=>{this.domElement.removeEventListener("mousemove",this.onMouseMove)},this.onMouseWheel=i=>{const a=i.deltaY>0?this.zoomSpeed*.1:-this.zoomSpeed*.1;this.targetRadiusDampedAction.addForce(a)},this.onContextMenu=i=>{i.preventDefault()},this.updateSphericalFromPosition(),this.domElement.addEventListener("touchstart",this.onTouchStart),this.domElement.addEventListener("touchend",this.onTouchEnd),this.domElement.addEventListener("mousedown",this.onMouseDown),this.domElement.addEventListener("mouseup",this.onMouseUp),this.domElement.addEventListener("wheel",this.onMouseWheel,{passive:!0}),this.domElement.addEventListener("contextmenu",this.onContextMenu),window.addEventListener("resize",this.onResize)}updateSphericalFromPosition(){const e=Pe();Yn(e,this.position,this.target);const n=Us(e),r=Math.atan2(e[0],e[2]),s=Math.acos(dt(e[1]/n,-1,1));this.spherical.radius=n,this.spherical.theta=r,this.spherical.phi=s}tick(){this.updateDampedAction(),this.updateCamera()}updateDampedAction(){this.target[0]+=this.targetXDampedAction.update(),this.target[1]+=this.targetYDampedAction.update(),this.target[2]+=this.targetZDampedAction.update(),this.spherical.theta+=this.targetThetaDampedAction.update(),this.spherical.phi+=this.targetPhiDampedAction.update(),this.spherical.radius+=this.targetRadiusDampedAction.update(),this.spherical.radius=dt(this.spherical.radius,this.minDistance,this.maxDistance),this.spherical.phi=dt(this.spherical.phi,this.minPolarAngle,this.maxPolarAngle)}updateCamera(){const e=this.spherical,n=Math.sin(e.phi)*e.radius;this.position[0]=n*Math.sin(e.theta)+this.target[0],this.position[1]=Math.cos(e.phi)*e.radius+this.target[1],this.position[2]=n*Math.cos(e.theta)+this.target[2],Bs(this.viewMatrix,this.position,this.target,vt.UP),Os(this.projectionMatrix,this.fov,this.aspectRatio,.1,100),Ds(this.viewProjectionMatrix,this.projectionMatrix,this.viewMatrix)}pan(e,n){const r=zs(this.position,this.target),s=this.fov*Math.PI/180,i=2*r*Math.tan(s*.5)/this.viewportHeight,a=ce(this.viewMatrix[0],this.viewMatrix[4],this.viewMatrix[8]),u=ce(this.viewMatrix[1],this.viewMatrix[5],this.viewMatrix[9]),d=Pe();Kn(a,a,-e*i),Kn(u,u,n*i),Fs(d,a,u),this.targetXDampedAction.addForce(d[0]),this.targetYDampedAction.addForce(d[1]),this.targetZDampedAction.addForce(d[2])}setTarget(e,n,r){Xn(this.target,e,n,r)}setPosition(e,n,r){Xn(this.position,e,n,r),this.updateSphericalFromPosition()}setDistance(e){this.spherical.radius=dt(e,this.minDistance,this.maxDistance)}getDistance(){return this.spherical.radius}setConstraints(e,n,r,s){this.minDistance=e,this.maxDistance=n,r!==void 0&&(this.minPolarAngle=r),s!==void 0&&(this.maxPolarAngle=s)}};vt.UP=ce(0,1,0);let Gt=vt;var Gs=function(){function t(e,n){for(var r=0;r<n.length;r++){var s=n[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}();function Hs(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var js=function(){function t(e,n){Hs(this,t),this._reset(),this.fileContents=e,this.defaultModelName=n||"untitled"}return Gs(t,[{key:"_reset",value:function(){this.result={models:[],materialLibraries:[]},this.currentMaterial="",this.currentGroup="",this.smoothingGroup=0}},{key:"parse",value:function(){this._reset();for(var e=function(a){var u=a.indexOf("#");return u>-1?a.substring(0,u):a},n=this.fileContents.split(`
`),r=0;r<n.length;r+=1){var s=e(n[r]),i=s.replace(/\s+/g," ").trim().split(" ");switch(i[0].toLowerCase()){case"o":this._parseObject(i);break;case"g":this._parseGroup(i);break;case"v":this._parseVertexCoords(i);break;case"vt":this._parseTextureCoords(i);break;case"vn":this._parseVertexNormal(i);break;case"l":this._parseLine(i);break;case"s":this._parseSmoothShadingStatement(i);break;case"f":this._parsePolygon(i);break;case"mtllib":this._parseMtlLib(i);break;case"usemtl":this._parseUseMtl(i);break}}return this.result}},{key:"_createNewModel",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.defaultModelName;return{name:e,vertices:[],textureCoords:[],vertexNormals:[],faces:[],lines:[]}}},{key:"_currentModel",value:function(){if(this.result.models.length==0){var e=this._createNewModel();this.result.models.push(e),this.currentGroup="",this.smoothingGroup=0}return this.result.models[this.result.models.length-1]}},{key:"_parseObject",value:function(e){var n=e.length>=2?e[1]:this.defaultModelName,r=this._createNewModel(n);this.result.models.push(r),this.currentGroup="",this.smoothingGroup=0}},{key:"_parseGroup",value:function(e){if(e.length!=2)throw"Group statements must have exactly 1 argument (eg. g group_1)";this.currentGroup=e[1]}},{key:"_parseVertexCoords",value:function(e){var n=e.length>=2?parseFloat(e[1]):0,r=e.length>=3?parseFloat(e[2]):0,s=e.length>=4?parseFloat(e[3]):0;this._currentModel().vertices.push({x:n,y:r,z:s})}},{key:"_parseTextureCoords",value:function(e){var n=e.length>=2?parseFloat(e[1]):0,r=e.length>=3?parseFloat(e[2]):0,s=e.length>=4?parseFloat(e[3]):0;this._currentModel().textureCoords.push({u:n,v:r,w:s})}},{key:"_parseVertexNormal",value:function(e){var n=e.length>=2?parseFloat(e[1]):0,r=e.length>=3?parseFloat(e[2]):0,s=e.length>=4?parseFloat(e[3]):0;this._currentModel().vertexNormals.push({x:n,y:r,z:s})}},{key:"_parseLine",value:function(e){var n=e.length-1;if(n<2)throw"Line statement has less than 2 vertices"+this.filePath+this.lineNumber;for(var r=[],s=0;s<n;s+=1){var i=e[s+1],a=i.split("/");if(a.length<1||a.length>2)throw"Too many values (separated by /) for a single vertex"+this.filePath+this.lineNumber;var u=0,d=0;u=parseInt(a[0]),a.length>1&&a[1]!=""&&(d=parseInt(a[1])),r.push({vertexIndex:u,textureCoordsIndex:d})}this._currentModel().lines.push(r)}},{key:"_parsePolygon",value:function(e){var n=e.length-1;if(n<3)throw"Face statement has less than 3 vertices"+this.filePath+this.lineNumber;for(var r={material:this.currentMaterial,group:this.currentGroup,smoothingGroup:this.smoothingGroup,vertices:[]},s=0;s<n;s+=1){var i=e[s+1],a=i.split("/");if(a.length<1||a.length>3)throw"Too many values (separated by /) for a single vertex"+this.filePath+this.lineNumber;var u=0,d=0,m=0;if(u=parseInt(a[0]),a.length>1&&a[1]!=""&&(d=parseInt(a[1])),a.length>2&&(m=parseInt(a[2])),u==0)throw"Faces uses invalid vertex index of 0";u<0&&(u=this._currentModel().vertices.length+1+u),r.vertices.push({vertexIndex:u,textureCoordsIndex:d,vertexNormalIndex:m})}this._currentModel().faces.push(r)}},{key:"_parseMtlLib",value:function(e){e.length>=2&&this.result.materialLibraries.push(e[1])}},{key:"_parseUseMtl",value:function(e){e.length>=2&&(this.currentMaterial=e[1])}},{key:"_parseSmoothShadingStatement",value:function(e){if(e.length!=2)throw"Smoothing group statements must have exactly 1 argument (eg. s <number|off>)";var n=e[1].toLowerCase()=="off"?0:parseInt(e[1]);this.smoothingGroup=n}}]),t}(),qs=js;const Xs=Nt(qs);var Ys=class fr{constructor(e){this._reset(),this.fileContents=e}_reset(){this.materials=[],this.currentMaterial=null,this.lineNumber=1,this.filename=""}parse(e="default"){return this._reset(),this.defaultMaterialName=e,this.fileContents.split(`
`).forEach((n,r)=>{this.lineNumber=r+1;const s=fr._stripComments(n).replace(/\s\s+/g," ").trim().split(" ");if(!(s.length==0||!s[0]))switch(s[0].toLowerCase()){case"newmtl":this._parseNewMTL(s);break;case"illum":this._parseIllum(s);break;case"ka":this._parseKa(s);break;case"kd":this._parseKd(s);break;case"ks":this._parseKs(s);break;case"tf":this._parseTF(s);break;case"ns":this._parseNs(s);break;case"ni":this._parseNi(s);break;case"d":this._parseD(s);break;case"tr":this._parseTr(s);break;case"sharpness":this._parseSharpness(s);break;case"map_ka":this._parseMapKa(s);break;case"map_kd":this._parseMapKd(s);break;case"map_ks":this._parseMapKs(s);break;case"map_ns":this._parseMapNs(s);break;case"map_d":this._parseMapD(s);break;case"disp":this._parseDisp(s);break;case"decal":this._parseDecal(s);break;case"bump":this._parseBump(s);break;case"refl":this._parseRefl(s);break;default:this._fileError(`Unrecognized statement: ${s[0]}`)}}),this.materials}static _stripComments(e){let n=e.indexOf("#");return n>-1?e.substring(0,n):e}_createMaterial(e){const n={name:e,illum:0,Ka:{method:"rgb",red:0,green:0,blue:0},Kd:{method:"rgb",red:0,green:0,blue:0},Ks:{method:"ks",red:0,green:0,blue:0},map_Ka:{file:null},map_Kd:{file:null},map_Ks:{file:null},map_d:{file:null},dissolve:1};this.materials.push(n)}_getCurrentMaterial(){return this.materials.length==0&&this._createMaterial(this.defaultMaterialName),this.materials[this.materials.length-1]}_parseNewMTL(e){if(e.length<2)throw"newmtl statement must specify a name for the maerial (eg, newmtl brickwall)";this._createMaterial(e[1])}_parseIllum(e){e.length<2&&this._fileError("to few arguments, expected: illum <number>"),this._getCurrentMaterial().illum=parseInt(e[1])}_parseKa(e){if(e.length!=4){this._notImplemented("Ka statements must have exactly 3 arguments (only Ka R G B syntax is supported");return}const n=this._getCurrentMaterial().Ka,r=this._parseKStatementRGB(e);n.red=r.red,n.green=r.green,n.blue=r.blue}_parseKd(e){if(e.length!=4){this._notImplemented("Kd statements must have exactly 3 arguments (only Kd R G B syntax is supported");return}const n=this._getCurrentMaterial().Kd,r=this._parseKStatementRGB(e);n.red=r.red,n.green=r.green,n.blue=r.blue}_parseKs(e){if(e.length!=4){this._notImplemented("Ks statements must have exactly 3 arguments (only Ks R G B syntax is supported");return}const n=this._getCurrentMaterial().Ks,r=this._parseKStatementRGB(e);n.red=r.red,n.green=r.green,n.blue=r.blue}_parseKStatementRGB(e){if(e.length<4&&this._fileError("to few arguments, expected: Ka/Kd/Ks keyword followed by: r g b values"),e[1].toLowerCase()=="spectral"){this._notImplemented("Ka spectral <filename> <factor>");return}else if(e[1].toLowerCase()=="xyz"){this._notImplemented("Ka xyz <x> <y> <z>");return}return{red:parseFloat(e[1]),green:parseFloat(e[2]),blue:parseFloat(e[3])}}_parseTF(e){this._notImplemented("tf")}_parseNs(e){this._notImplemented("Ns")}_parseNi(e){this._notImplemented("Ni")}_parseD(e){e.length<2&&this._fileError("to few arguments, expected: d <factor>"),this._getCurrentMaterial().dissolve=parseFloat(e[1])}_parseTr(e){e.length<2&&this._fileError("to few arguments, expected: Tr <factor>"),this._getCurrentMaterial().dissolve=1-parseFloat(e[1])}_parseSharpness(e){this._notImplemented("sharpness")}_parseMapKa(e){e.length<2&&this._fileError("to few arguments, expected: map_ka <textureImageFile>");const n=e[e.length-1];this._getCurrentMaterial().map_Ka.file=n}_parseMapKd(e){e.length<2&&this._fileError("to few arguments, expected: map_Kd <textureImageFile>");const n=e[e.length-1];this._getCurrentMaterial().map_Kd.file=n}_parseMapD(e){e.length<2&&this._fileError("to few arguments, expected: map_d <textureImageFile>");const n=e[e.length-1];this._getCurrentMaterial().map_d.file=n}_parseMapKs(e){e.length<2?this._fileError("to few arguments, expected: map_Ks <textureImageFile>"):e.length>2;const n=e[e.length-1];this._getCurrentMaterial().map_Ks.file=n}_parseMapNs(e){this._notImplemented("map_Ns")}_parseDisp(e){this._notImplemented("disp")}_parseDecal(e){this._notImplemented("decal")}_parseBump(e){this._notImplemented("bump")}_parseRefl(e){this._notImplemented("bump")}_notImplemented(e){console.warn(`MTL file statement not implemented: ${e}`)}_fileError(e){const n=`Material: ${this._getCurrentMaterial().name}`;throw`MTL file format error (${`Line: ${this.lineNumber}`}  ${n}): ${e}`}},Ks=Ys;const Ws=Nt(Ks),q=class q{constructor(e,n){this.min=e,this.max=n,this.lt=-1,this.rt=-1,this.fi=[-1,-1]}subdivide(e,n){if(e.length<=this.fi.length)for(let r=0;r<e.length;r++)this.fi[r]=e[r].fi;else{const r=Math.abs(this.max[0]-this.min[0]),s=Math.abs(this.max[1]-this.min[1]),i=Math.abs(this.max[2]-this.min[2]),a=Math.max(r,s,i);a===r?this.splitAcross(q.X_AXIS,e,n):a===s?this.splitAcross(q.Y_AXIS,e,n):this.splitAcross(q.Z_AXIS,e,n)}}splitAcross(e,n,r){const s=[...n].sort((h,p)=>{const y=h.p0[e],S=h.p1[e],b=h.p2[e],F=p.p0[e],I=p.p1[e],Y=p.p2[e];return(y+S+b)/3-(F+I+Y)/3}),i=s.length/2,a=s.length,u=s.slice(0,i),d=s.slice(i,a);let m,v;if(u.length){const h=Ie(Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,1),p=Ie(Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,1);for(const y of u)h[0]=Math.min(h[0],y.p0[0],y.p1[0],y.p2[0]),h[1]=Math.min(h[1],y.p0[1],y.p1[1],y.p2[1]),h[2]=Math.min(h[2],y.p0[2],y.p1[2],y.p2[2]),p[0]=Math.max(p[0],y.p0[0],y.p1[0],y.p2[0]),p[1]=Math.max(p[1],y.p0[1],y.p1[1],y.p2[1]),p[2]=Math.max(p[2],y.p0[2],y.p1[2],y.p2[2]);p[0]-h[0]<q.BV_MIN_DELTA&&(p[0]+=q.BV_MIN_DELTA),p[1]-h[1]<q.BV_MIN_DELTA&&(p[1]+=q.BV_MIN_DELTA),p[2]-h[2]<q.BV_MIN_DELTA&&(p[2]+=q.BV_MIN_DELTA),this.lt=r.length,m=new q(h,p),r.push(m)}if(d.length){const h=Ie(Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,1),p=Ie(Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,1);for(const y of d)h[0]=Math.min(h[0],y.p0[0],y.p1[0],y.p2[0]),h[1]=Math.min(h[1],y.p0[1],y.p1[1],y.p2[1]),h[2]=Math.min(h[2],y.p0[2],y.p1[2],y.p2[2]),p[0]=Math.max(p[0],y.p0[0],y.p1[0],y.p2[0]),p[1]=Math.max(p[1],y.p0[1],y.p1[1],y.p2[1]),p[2]=Math.max(p[2],y.p0[2],y.p1[2],y.p2[2]);p[0]-h[0]<q.BV_MIN_DELTA&&(p[0]+=q.BV_MIN_DELTA),p[1]-h[1]<q.BV_MIN_DELTA&&(p[1]+=q.BV_MIN_DELTA),p[2]-h[2]<q.BV_MIN_DELTA&&(p[2]+=q.BV_MIN_DELTA),this.rt=r.length,v=new q(h,p),r.push(v)}m&&m.subdivide(u,r),v&&v.subdivide(d,r)}};q.BV_MIN_DELTA=.01,q.X_AXIS=0,q.Y_AXIS=1,q.Z_AXIS=2;let ge=q;const Re=class Re{constructor(e,n=Re.LAMBERTIAN_MATERIAL,r=0,s=1,i=1){this.albedo=e,this.mtlType=n,this.reflectionRatio=r,this.reflectionGloss=s,this.refractionIndex=i}};Re.EMISSIVE_MATERIAL=0,Re.REFLECTIVE_MATERIAL=1,Re.DIELECTRIC_MATERIAL=2,Re.LAMBERTIAN_MATERIAL=3;let _e=Re;const G=class G{constructor(e){this.device=e}static parseModel(e,n){let r=[],s=[];console.log(e);const i=Pe(),a=Pe(),u=Pe();return e.map(({vertices:d,vertexNormals:m,faces:v},h)=>{r=r.concat(d),s=s.concat(m);const p=[];for(const I of v){const Y=I.vertices[0].vertexIndex-1,R=I.vertices[1].vertexIndex-1,U=I.vertices[2].vertexIndex-1,O=0,A=ce(r[Y].x,r[Y].y+O,r[Y].z),C=ce(r[R].x,r[R].y+O,r[R].z),E=ce(r[U].x,r[U].y+O,r[U].z),z=I.vertices[0].vertexNormalIndex-1,B=I.vertices[1].vertexNormalIndex-1,N=I.vertices[2].vertexNormalIndex-1,K=ce(s[z].x,s[z].y,s[z].z),J=ce(s[B].x,s[B].y,s[B].z),M=ce(s[N].x,s[N].y,s[N].z);Wn(a,C,A),Wn(u,E,A),Vs(i,a,u),Ps(i,i),p.push({p0:A,p1:C,p2:E,n0:K,n1:J,n2:M,fn:Ls(i),fi:p.length,mi:n.findIndex(({name:w})=>w===I.material)})}const y=[],S=Ie(Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,1),b=Ie(Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,Number.MIN_SAFE_INTEGER,1);for(const I of p)S[0]=Math.min(S[0],I.p0[0],I.p1[0],I.p2[0]),S[1]=Math.min(S[1],I.p0[1],I.p1[1],I.p2[1]),S[2]=Math.min(S[2],I.p0[2],I.p1[2],I.p2[2]),b[0]=Math.max(b[0],I.p0[0],I.p1[0],I.p2[0]),b[1]=Math.max(b[1],I.p0[1],I.p1[1],I.p2[1]),b[2]=Math.max(b[2],I.p0[2],I.p1[2],I.p2[2]);b[0]-S[0]<ge.BV_MIN_DELTA&&(b[0]+=ge.BV_MIN_DELTA),b[1]-S[1]<ge.BV_MIN_DELTA&&(b[1]+=ge.BV_MIN_DELTA),b[2]-S[2]<ge.BV_MIN_DELTA&&(b[2]+=ge.BV_MIN_DELTA);const F=new ge(S,b);return y.push(F),F.subdivide(p,y),{faces:p,AABBs:y}})}static parseMaterial(e){return e.map(n=>{const r=new _e(Ie(n.Kd.red,n.Kd.green,n.Kd.blue,1));switch(n.name){case"Light":r.mtlType=_e.EMISSIVE_MATERIAL,r.albedo[0]=6,r.albedo[1]=6,r.albedo[2]=6;break;case"Dodecahedron":break;case"Floor":r.mtlType=_e.REFLECTIVE_MATERIAL,r.reflectionRatio=.2,r.reflectionGloss=.4;break;case"Teapot":r.mtlType=_e.REFLECTIVE_MATERIAL,r.reflectionRatio=1,r.reflectionGloss=.4,r.refractionIndex=1.523;break;case"Suzanne":r.mtlType=_e.REFLECTIVE_MATERIAL,r.reflectionRatio=.1,r.reflectionGloss=1,r.refractionIndex=.1;break;case"Dodecahedron":r.mtlType=_e.DIELECTRIC_MATERIAL,r.refractionIndex=1.52;break}return r})}set isSuzanneGlass(e){const n=new ArrayBuffer(8*Float32Array.BYTES_PER_ELEMENT),r=new Float32Array(n),s=new Uint32Array(n),i=this.sceneMaterials[this.suzanneMaterialIdx];s[0]=e?_e.DIELECTRIC_MATERIAL:_e.REFLECTIVE_MATERIAL,r[1]=i.reflectionRatio,r[2]=i.reflectionGloss,r[3]=i.refractionIndex,r[4]=e?1:i.albedo[0],r[5]=e?1:i.albedo[1],r[6]=e?1:i.albedo[2],this.device.queue.writeBuffer(this.materialsBuffer,this.suzanneMaterialIdx*8*Float32Array.BYTES_PER_ELEMENT,n)}async loadModels(){const[e,n]=await Promise.all([G.loadObjFileContents("raytraced-scene.obj"),G.loadMtlFileContents("raytraced-scene.mtl")]),r=G.parseModel(e.models,n),s=G.parseMaterial(n);this.suzanneMaterialIdx=n.findIndex(({name:i})=>i==="Suzanne"),this.sceneMaterials=s,G.MODELS_COUNT=r.length;{G.MAX_NUM_FACES_PER_MESH=r.reduce((m,v)=>Math.max(m,v.faces.length),0);const i=28;this.facesBuffer=this.device.createBuffer({size:i*Float32Array.BYTES_PER_ELEMENT*G.MAX_NUM_FACES_PER_MESH*G.MODELS_COUNT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),this.facesBuffer.label="Faces Buffer";const a=this.facesBuffer.getMappedRange(),u=new Float32Array(a),d=new Uint32Array(a);for(let m=0;m<G.MODELS_COUNT;m++){const v=r[m].faces;let h=m*i*G.MAX_NUM_FACES_PER_MESH;for(const p of v)u[h+0]=p.p0[0],u[h+1]=p.p0[1],u[h+2]=p.p0[2],u[h+4]=p.p1[0],u[h+5]=p.p1[1],u[h+6]=p.p1[2],u[h+8]=p.p2[0],u[h+9]=p.p2[1],u[h+10]=p.p2[2],u[h+12]=p.n0[0],u[h+13]=p.n0[1],u[h+14]=p.n0[2],u[h+16]=p.n1[0],u[h+17]=p.n1[1],u[h+18]=p.n1[2],u[h+20]=p.n2[0],u[h+21]=p.n2[1],u[h+22]=p.n2[2],u[h+24]=p.fn[0],u[h+25]=p.fn[1],u[h+26]=p.fn[2],d[h+27]=p.mi,h+=i}this.facesBuffer.unmap()}{G.MAX_NUM_BVs_PER_MESH=r.reduce((m,v)=>Math.max(m,v.AABBs.length),0);const i=12;G.AABBS_COUNT=G.MAX_NUM_BVs_PER_MESH*G.MODELS_COUNT,this.aabbsBuffer=this.device.createBuffer({size:i*Float32Array.BYTES_PER_ELEMENT*G.AABBS_COUNT,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0}),this.aabbsBuffer.label="AABBs Buffer";const a=this.aabbsBuffer.getMappedRange(),u=new Float32Array(a),d=new Int32Array(a);for(let m=0;m<G.MODELS_COUNT;m++){const v=r[m].AABBs;let h=i*G.MAX_NUM_BVs_PER_MESH*m;for(const p of v)u[h+0]=p.min[0],u[h+1]=p.min[1],u[h+2]=p.min[2],u[h+3]=1,u[h+4]=p.max[0],u[h+5]=p.max[1],u[h+6]=p.max[2],d[h+7]=p.lt,d[h+8]=p.rt,d[h+9]=p.fi[0],d[h+10]=p.fi[1],d[h+11]=0,h+=i}this.aabbsBuffer.unmap();{G.MATERIALS_COUNT=s.length;const m=8;this.materialsBuffer=this.device.createBuffer({size:m*Float32Array.BYTES_PER_ELEMENT*G.MATERIALS_COUNT,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,mappedAtCreation:!0}),this.materialsBuffer.label="Materials Buffer";const v=this.materialsBuffer.getMappedRange(),h=new Float32Array(v),p=new Uint32Array(v);for(let y=0;y<s.length;y++){const S=s[y],b=y*m;p[b+0]=S.mtlType,h[b+1]=S.reflectionRatio,h[b+2]=S.reflectionGloss,h[b+3]=S.refractionIndex,h[b+4]=S.albedo[0],h[b+5]=S.albedo[1],h[b+6]=S.albedo[2]}this.materialsBuffer.unmap()}}}};G.AABBS_COUNT=0,G.MODELS_COUNT=0,G.MATERIALS_COUNT=0,G.MAX_NUM_BVs_PER_MESH=0,G.MAX_NUM_FACES_PER_MESH=0,G.loadObjFileContents=async e=>{const n=await(await fetch(e)).text();return new Xs(n).parse()},G.loadMtlFileContents=async e=>{const n=await(await fetch(e)).text();return new Ws(n).parse()};let Ce=G;const Zs=/#([^\s]*)(\s*)/gm;class Zn{constructor(e){Jt(this,"elseIsValid",!0);Jt(this,"branches",[]);this.pushBranch("if",e)}pushBranch(e,n){if(!this.elseIsValid)throw new Error(`#${e} not preceeded by an #if or #elif`);this.elseIsValid=e==="if"||e==="elif",this.branches.push({expression:!!n,string:""})}appendStringToCurrentBranch(...e){for(const n of e)this.branches[this.branches.length-1].string+=n}resolve(){for(const e of this.branches)if(e.expression)return e.string;return""}}function se(t,...e){const n=[];let r=new Zn(!0);r.elseIsValid=!1;const s=(i,a)=>{if(i.index+i[0].length!=a.length)throw new Error(`#${i[1]} must be immediately followed by a template expression (ie: \${value})`)};for(let i=0;i<t.length;++i){const a=t[i],u=a.matchAll(Zs);let d=0,m=!1;for(const v of u){switch(r.appendStringToCurrentBranch(a.substring(d,v.index)),v[1]){case"if":s(v,a),m=!0,n.push(r),r=new Zn(e[i]);break;case"elif":s(v,a),m=!0,r.pushBranch(v[1],e[i]);break;case"else":r.pushBranch(v[1],!0),r.appendStringToCurrentBranch(v[2]);break;case"endif":if(!n.length)throw new Error(`#${v[1]} not preceeded by an #if`);const h=r.resolve();r=n.pop(),r.appendStringToCurrentBranch(h,v[2]);break;default:r.appendStringToCurrentBranch(v[0]);break}d=v.index+v[0].length}d!=a.length&&r.appendStringToCurrentBranch(a.substring(d,a.length)),!m&&e.length>i&&r.appendStringToCurrentBranch(e[i])}if(n.length)throw new Error("Mismatched #if/#endif count");return r.resolve()}const _t=se`
  struct CommonUniforms {
    // Random seed for the workgroup
    seed : vec3u,
    frameCounter: u32,
    maxBounces: u32,
    flatShading: u32,
    debugNormals: u32
  }

  struct HitRecord {
    p: vec3f,
    normal: vec3f,
    t: f32,
    frontFace: bool,
    materialIdx: u32,
    meshIdx: i32
  };

  struct Face {
    p0: vec3f,
    p1: vec3f,
    p2: vec3f,

    n0: vec3f,
    n1: vec3f,
    n2: vec3f,

    faceNormal: vec3f,
    materialIdx: u32
  }

  struct AABB {
    min: vec3f,
    max: vec3f,
    leftChildIdx: i32,
    rightChildIdx: i32,
    faceIdx0: i32,
    faceIdx1: i32
  }

  struct Mesh {
    aabbOffset: i32,
    faceOffset: i32
  }
`,Jn=se`
  struct VertexOutput {
    @builtin(position) Position: vec4f,
    @location(0) uv: vec2f,
  }

`,Js=se`
  ${_t}
  ${Jn}

  @group(0) @binding(0) var<storage, read> AABBs: array<AABB>;
  @group(0) @binding(1) var<uniform> viewProjectionMatrix: mat4x4f;

  const EDGES_PER_CUBE = 12u;

  @vertex
  fn vertexMain(
    @builtin(instance_index) instanceIndex: u32,
    @builtin(vertex_index) vertexIndex: u32
  ) -> @builtin(position) vec4f {
    let lineInstanceIdx = instanceIndex % EDGES_PER_CUBE;
    let aabbInstanceIdx = instanceIndex / EDGES_PER_CUBE;
    let a = AABBs[aabbInstanceIdx];
    var pos: vec3f;
    let fVertexIndex = f32(vertexIndex);
                  
    //        a7 _______________ a6
    //         / |             /|
    //        /  |            / |
    //    a4 /   |       a5  /  |
    //      /____|__________/   |
    //      |    |__________|___|
    //      |   / a3        |   / a2
    //      |  /            |  /
    //      | /             | /
    //      |/______________|/
    //      a0              a1

    let dx = a.max.x - a.min.x;
    let dy = a.max.y - a.min.y;
    let dz = a.max.z - a.min.z;
    
    let a0 = a.min;
    let a1 = vec3f(a.min.x + dx, a.min.y,      a.min.z     );
    let a2 = vec3f(a.min.x + dx, a.min.y,      a.min.z + dz);
    let a3 = vec3f(a.min.x,      a.min.y,      a.min.z + dz);
    let a4 = vec3f(a.min.x,      a.min.y + dy, a.min.z     );
    let a5 = vec3f(a.min.x + dx, a.min.y + dy, a.min.z     );
    let a6 = a.max;
    let a7 = vec3f(a.min.x,      a.min.y + dy, a.min.z + dz);

    if (lineInstanceIdx == 0) {
      pos = mix(a0, a1, fVertexIndex);
    } else if (lineInstanceIdx == 1) {
      pos = mix(a1, a2, fVertexIndex);
    } else if (lineInstanceIdx == 2) {
      pos = mix(a2, a3, fVertexIndex);
    } else if (lineInstanceIdx == 3) {
      pos = mix(a0, a3, fVertexIndex);
    } else if (lineInstanceIdx == 4) {
      pos = mix(a0, a4, fVertexIndex);
    } else if (lineInstanceIdx == 5) {
      pos = mix(a1, a5, fVertexIndex);
    } else if (lineInstanceIdx == 6) {
      pos = mix(a2, a6, fVertexIndex);
    } else if (lineInstanceIdx == 7) {
      pos = mix(a3, a7, fVertexIndex);
    } else if (lineInstanceIdx == 8) {
      pos = mix(a4, a5, fVertexIndex);
    } else if (lineInstanceIdx == 9) {
      pos = mix(a5, a6, fVertexIndex);
    } else if (lineInstanceIdx == 10) {
      pos = mix(a6, a7, fVertexIndex);
    } else if (lineInstanceIdx == 11) {
      pos = mix(a7, a4, fVertexIndex);
    }
    return viewProjectionMatrix * vec4(pos, 1);
  }

  @fragment
  fn fragmentMain() -> @location(0) vec4f {
    return vec4f(0.01);
  }

`,Ht=se`
  struct Camera {
    viewportSize: vec2u,
    imageWidth: f32,
    imageHeight: f32,
    pixel00Loc: vec3<f32>,
    pixelDeltaU: vec3<f32>,
    pixelDeltaV: vec3<f32>,

    aspectRatio: f32,
    center: vec3<f32>,
    vfov: f32,

    lookFrom: vec3f,
    lookAt: vec3f,
    vup: vec3f,

    defocusAngle: f32,
    focusDist: f32,

    defocusDiscU: vec3f,
    defocusDiscV: vec3f
  }

  fn initCamera(camera: ptr<function, Camera>) {
    (*camera).imageHeight = (*camera).imageWidth / (*camera).aspectRatio;
    (*camera).imageHeight = select((*camera).imageHeight, 1, (*camera).imageHeight < 1);

    (*camera).center = (*camera).lookFrom;

    let theta = radians((*camera).vfov);
    let h = tan(theta * 0.5);
    let viewportHeight = 2.0 * h * (*camera).focusDist;
    let viewportWidth = viewportHeight * ((*camera).imageWidth / (*camera).imageHeight);

    let w = normalize((*camera).lookFrom - (*camera).lookAt);
    let u = normalize(cross((*camera).vup, w));
    let v = cross(w, u);

    let viewportU = viewportWidth * u;
    let viewportV = viewportHeight * -v;

    (*camera).pixelDeltaU = viewportU / (*camera).imageWidth;
    (*camera).pixelDeltaV = viewportV / (*camera).imageHeight;

    let viewportUpperLeft = (*camera).center - ((*camera).focusDist * w) - viewportU / 2 - viewportV / 2;
    (*camera).pixel00Loc = viewportUpperLeft + 0.5 * ((*camera).pixelDeltaU + (*camera).pixelDeltaV);

    let defocusRadius = (*camera).focusDist * tan(radians((*camera).defocusAngle * 0.5));
    (*camera).defocusDiscU = u * defocusRadius;
    (*camera).defocusDiscV = v * defocusRadius;
  }
`,Qn=se`
  // Narkowicz 2015, "ACES Filmic Tone Mapping Curve"
  @must_use
  fn aces(x: vec3f) -> vec3f {
    let a = 2.51;
    let b = 0.03;
    let c = 2.43;
    let d = 0.59;
    let e = 0.14;
    return saturate(x * (a * x + b)) / (x * (c * x + d) + e);
  }

  // Filmic Tonemapping Operators http://filmicworlds.com/blog/filmic-tonemapping-operators/
  @must_use
  fn filmic(x: vec3f) -> vec3f {
    let X = max(vec3f(0.0), x - 0.004);
    let result = (X * (6.2 * X + 0.5)) / (X * (6.2 * X + 1.7) + 0.06);
    return pow(result, vec3(2.2));
  }

  // Lottes 2016, "Advanced Techniques and Optimization of HDR Color Pipelines"
  @must_use
  fn lottes(x: vec3f) -> vec3f {
    let a = vec3f(1.6);
    let d = vec3f(0.977);
    let hdrMax = vec3f(8.0);
    let midIn = vec3f(0.18);
    let midOut = vec3f(0.267);

    let b =
        (-pow(midIn, a) + pow(hdrMax, a) * midOut) /
        ((pow(hdrMax, a * d) - pow(midIn, a * d)) * midOut);
    let c =
        (pow(hdrMax, a * d) * pow(midIn, a) - pow(hdrMax, a) * pow(midIn, a * d) * midOut) /
        ((pow(hdrMax, a * d) - pow(midIn, a * d)) * midOut);

    return pow(x, a) / (pow(x, a * d) * b + c);
  }

  @must_use
  fn reinhard(x: vec3f) -> vec3f {
    return x / (1.0 + x);
  }
`,Qs=se`
  ${Ht}
  ${Qn}
  ${Jn}
  ${_t}

  @group(0) @binding(0) var<storage, read_write> raytraceImageBuffer: array<vec3f>;
  @group(0) @binding(1) var<uniform> cameraUniforms: Camera;
  @group(0) @binding(2) var<uniform> commonUniforms: CommonUniforms;

  // xy pos + uv
  const FULLSCREEN_QUAD = array<vec4<f32>, 6>(
    vec4(-1, 1, 0, 0),
    vec4(-1, -1, 0, 1),
    vec4(1, -1, 1, 1),
    vec4(-1, 1, 0, 0),
    vec4(1, -1, 1, 1),
    vec4(1, 1, 1, 0)
  );

  @vertex
  fn vertexMain(@builtin(vertex_index) VertexIndex: u32) -> VertexOutput {
    var output: VertexOutput;
    output.Position = vec4<f32>(FULLSCREEN_QUAD[VertexIndex].xy, 0.0, 1.0);
    output.uv = FULLSCREEN_QUAD[VertexIndex].zw;
    return output;
  }

  @fragment
  fn fragmentMain(@location(0) uv: vec2<f32>) -> @location(0) vec4f {
    let x = u32(uv.x * f32(cameraUniforms.viewportSize.x));
    let y = u32(uv.y * f32(cameraUniforms.viewportSize.y));
    let idx = x + y * cameraUniforms.viewportSize.x;
    let color = lottes(raytraceImageBuffer[idx] / f32(commonUniforms.frameCounter + 1));
    return vec4f(color, 1.0);
  }
`,ei=se`
  const f32min = 0x1p-126f;
  const f32max = 0x1.fffffep+127;

  const pi = ${Math.PI};

  @must_use
  fn rngNextFloat(state: ptr<function, u32>) -> f32 {
    rngNextInt(state);
    return f32(*state) / f32(0xffffffffu);
  }

  fn rngNextInt(state: ptr<function, u32>) {
    // PCG random number generator
    // Based on https://www.shadertoy.com/view/XlGcRh

    let oldState = *state + 747796405u + 2891336453u;
    let word = ((oldState >> ((oldState >> 28u) + 4u)) ^ oldState) * 277803737u;
    *state = (word >> 22u) ^ word;
  }

  @must_use
  fn randInRange(min: f32, max: f32, state: ptr<function, u32>) -> f32 {
    return min + rngNextFloat(state) * (max - min);
  }
`,ti=se`
  struct Ray {
    origin: vec3f,
    direction: vec3f,
  };

  @must_use
  fn rayAt(ray: ptr<function, Ray>, t: f32) -> vec3f {
    return (*ray).origin + (*ray).direction * t;
  }

  @must_use
  fn rayIntersectFace(
    ray: ptr<function, Ray>,
    face: ptr<function, Face>,
    rec: ptr<function, HitRecord>,
    interval: Interval
  ) -> bool {
    // Mller-Trumbore algorithm
    // https://en.wikipedia.org/wiki/MllerTrumbore_intersection_algorithm

    // let fnDotRayDir = dot((*face).faceNormal, (*ray).direction);
    // if (abs(fnDotRayDir) < EPSILON) {
    //   return false; // ray direction almost parallel
    // }

    let e1 = (*face).p1 - (*face).p0;
    let e2 = (*face).p2 - (*face).p0;

    let h = cross((*ray).direction, e2);
    let det = dot(e1, h);

    if det > -0.00001 && det < 0.00001 {
      return false;
    }

    let invDet = 1.0f / det;
    let s = (*ray).origin - (*face).p0;
    let u = invDet * dot(s, h);

    if u < 0.0f || u > 1.0f {
      return false;
    }

    let q = cross(s, e1);
    let v = invDet * dot((*ray).direction, q);

    if v < 0.0f || u + v > 1.0f {
      return false;
    }

    let t = invDet * dot(e2, q);

    if t > interval.min && t < interval.max {
      // https://www.scratchapixel.com/lessons/3d-basic-rendering/ray-tracing-rendering-a-triangle/moller-trumbore-ray-triangle-intersection.html
      
      let p = (*face).p0 + u * e1 + v * e2;
      // *hit = TriangleHit(offsetRay(p, n), b, t);
      (*rec).t = t;
      (*rec).p = p;
      (*rec).materialIdx = (*face).materialIdx;
      if (commonUniforms.flatShading == 1u) {
        (*rec).normal = (*face).faceNormal;
      } else {
        let b = vec3f(1f - u - v, u, v);
        let n = b[0] * (*face).n0 + b[1] * (*face).n1 + b[2] * (*face).n2;
        (*rec).normal = n;
      }
      return true;
    } else {
      return false;
    }
  }


  @must_use
  fn rayIntersectBV(ray: ptr<function, Ray>, aabb: ptr<function, AABB>) -> bool {
    let t0 = ((*aabb).min - (*ray).origin) / (*ray).direction;
    let t1 = ((*aabb).max - (*ray).origin) / (*ray).direction;
    let tmin = min(t0, t1);
    let tmax = max(t0, t1);
    let maxMinT = max(tmin.x, max(tmin.y, tmin.z));
    let minMaxT = min(tmax.x, min(tmax.y, tmax.z));
    return maxMinT < minMaxT;
  }

  @must_use
  fn rayIntersectBVH(
    ray: ptr<function, Ray>,
    hitRec: ptr<function, HitRecord>,
    interval: Interval
  ) -> bool {
    
    var current: HitRecord;
    var didIntersect = false;
    var stack: array<i32, BV_MAX_STACK_DEPTH>;

    (*hitRec).t = f32max;
    
    var top: i32;

    for (var objIdx = 0u; objIdx < OBJECTS_COUNT_IN_SCENE; objIdx++) {
      top = 0;
      stack[0] = 0;

      while (top > -1) {
        var bvIdx = stack[top];
        top--;
        var aabb = AABBs[u32(bvIdx) + objIdx * MAX_BVs_COUNT_PER_MESH];
        
        if (rayIntersectBV(ray, &aabb)) {
          if (aabb.leftChildIdx != -1) {
            top++;
            stack[top] = aabb.leftChildIdx;
          }
          if (aabb.rightChildIdx != -1) {
            top++;
            stack[top] = aabb.rightChildIdx;
          }

          if (aabb.faceIdx0 != -1) {
            var face = faces[u32(aabb.faceIdx0) + objIdx * MAX_FACES_COUNT_PER_MESH];
            if (
              rayIntersectFace(ray, &face, &current, positiveUniverseInterval) &&
              current.t < (*hitRec).t
            ) {
              *hitRec = current;
              didIntersect = true;
            }
          }

          if (aabb.faceIdx1 != -1) {
            var face = faces[u32(aabb.faceIdx1) + objIdx * MAX_FACES_COUNT_PER_MESH];
            if (
              rayIntersectFace(ray, &face, &current, positiveUniverseInterval) &&
              current.t < (*hitRec).t
            ) {
              *hitRec = current;
              didIntersect = true;
            }
          }
        }
      }
    }
    return didIntersect;
  }

  @must_use
  fn getCameraRay(camera: ptr<function, Camera>, i: f32, j: f32, rngState: ptr<function, u32>) -> Ray {
    let pixelCenter = (*camera).pixel00Loc + (i * (*camera).pixelDeltaU) + (j * (*camera).pixelDeltaV);
    let pixelSample = pixelCenter + pixelSampleSquare(camera, rngState);
    let rayOrigin = select(defocusDiskSample(camera, rngState), (*camera).center, (*camera).defocusAngle <= 0);
    let rayDirection = pixelSample - rayOrigin;
    return Ray(rayOrigin, rayDirection);
  }

  @must_use
  fn defocusDiskSample(camera: ptr<function, Camera>, rngState: ptr<function, u32>) -> vec3f {
    let p = randomVec3InUnitDisc(rngState);
    return (*camera).center + (p.x * (*camera).defocusDiscU) + (p.y * (*camera).defocusDiscV);
  }

  @must_use
  fn pixelSampleSquare(camera: ptr<function, Camera>, rngState: ptr<function, u32>) -> vec3<f32> {
    let px = -0.5 + rngNextFloat(rngState);
    let py = -0.5 + rngNextFloat(rngState);
    return (px * (*camera).pixelDeltaU) + (py * (*camera).pixelDeltaV);
  }
`,ni=se`
  @must_use
  fn randomVec3(rngState: ptr<function, u32>) -> vec3f {
    return vec3f(rngNextFloat(rngState), rngNextFloat(rngState), rngNextFloat(rngState));
  }
  
  @must_use
  fn randomVec3InRange(min: f32, max: f32, rngState: ptr<function, u32>) -> vec3f {
    return vec3f(
      randInRange(min, max, rngState),
      randInRange(min, max, rngState),
      randInRange(min, max, rngState)
    );
  }
  
  fn randomVec3InUnitDisc(state: ptr<function, u32>) -> vec3<f32> {
    let r = sqrt(rngNextFloat(state));
    let alpha = 2f * pi * rngNextFloat(state);

    let x = r * cos(alpha);
    let y = r * sin(alpha);

    return vec3(x, y, 0f);
  }

  fn randomVec3InUnitSphere(state: ptr<function, u32>) -> vec3<f32> {
    let r = pow(rngNextFloat(state), 0.33333f);
    let theta = pi * rngNextFloat(state);
    let phi = 2f * pi * rngNextFloat(state);

    let x = r * sin(theta) * cos(phi);
    let y = r * sin(theta) * sin(phi);
    let z = r * cos(theta);

    return vec3(x, y, z);
  }
  
  @must_use
  fn randomUnitVec3(rngState: ptr<function, u32>) -> vec3f {
    return normalize(randomVec3InUnitSphere(rngState));
  }
  
  @must_use
  fn randomUnitVec3OnHemisphere(normal: vec3f, rngState: ptr<function, u32>) -> vec3f {
    let onUnitSphere = randomUnitVec3(rngState);
    return select(-onUnitSphere, onUnitSphere, dot(onUnitSphere, normal) > 0.0);
  }

  @must_use
  fn nearZero(v: vec3f) -> bool {
    let epsilon = vec3f(1e-8);
    return any(abs(v) < epsilon);
  }
`,ri=se`
  struct Interval {
    min: f32,
    max: f32,
  };

  @must_use
  fn intervalContains(interval: Interval, x: f32) -> bool {
    return interval.min <= x && x <= interval.max;
  }

  @must_use
  fn intervalSurrounds(interval: Interval, x: f32) -> bool {
    return interval.min < x && x < interval.max;
  }

  @must_use
  fn intervalClamp(interval: Interval, x: f32) -> f32 {
    var out = x;
    if (x < interval.min) {
      out = interval.min;
    }
    if (x > interval.max) {
      out = interval.max;
    }
    return out;
  }

  const emptyInterval = Interval(f32max, f32min);
  const universeInterval = Interval(f32min, f32max);
  const positiveUniverseInterval = Interval(EPSILON, f32max);
`,si=se`
  struct Material {
    materialType: u32,
    reflectionRatio: f32,
    reflectionGloss: f32,
    refractionIndex: f32,
    albedo: vec3f,
  };

  @must_use
  fn scatterLambertian(
    material: ptr<function, Material>,
    ray: ptr<function, Ray>,
    scattered: ptr<function, Ray>,
    hitRec: ptr<function, HitRecord>,
    attenuation: ptr<function, vec3f>,
    rngState: ptr<function, u32>
  ) -> bool {
    var scatterDirection = (*hitRec).normal + randomUnitVec3(rngState);
    if (nearZero(scatterDirection)) {
      scatterDirection = (*hitRec).normal;
    }
    (*scattered) = Ray((*hitRec).p, scatterDirection);
    (*attenuation) = (*material).albedo;
    return true;
  }

  @must_use
  fn scatterMetal(
    material: ptr<function, Material>,
    ray: ptr<function, Ray>,
    scattered: ptr<function, Ray>,
    hitRec: ptr<function, HitRecord>,
    attenuation: ptr<function, vec3f>,
    rngState: ptr<function, u32>
  ) -> bool {
    let reflected = reflect(normalize((*ray).direction), (*hitRec).normal);
    (*scattered) = Ray((*hitRec).p, reflected + (*material).reflectionGloss * randomUnitVec3(rngState));
    (*attenuation) = (*material).albedo;
    return (dot((*scattered).direction, (*hitRec).normal) >= 0);
  }

  @must_use
  fn scatterDielectric(
    material: ptr<function, Material>,
    ray: ptr<function, Ray>,
    scattered: ptr<function, Ray>,
    hitRec: ptr<function, HitRecord>,
    attenuation: ptr<function, vec3f>,
    rngState: ptr<function, u32>
  ) -> bool {
    *attenuation = vec3f(1);
    let refractRatio = select((*material).refractionIndex, 1.0 / (*material).refractionIndex, (*hitRec).frontFace);
    let unitDirection = normalize((*ray).direction);
    let cosTheta = dot(-unitDirection, (*hitRec).normal);
    let sinTheta = sqrt(1.0 - cosTheta * cosTheta);
    let cannotRefract = refractRatio * sinTheta > 1.0;
    let direction = select(
      refract(unitDirection, (*hitRec).normal, refractRatio),
      reflect(unitDirection, (*hitRec).normal),
      cannotRefract || reflectance(cosTheta, refractRatio) > rngNextFloat(rngState)
    );
    (*scattered) = Ray((*hitRec).p, direction);
    return true;
  }

  @must_use
  fn reflectance(cosine: f32, refractionIndex: f32) -> f32 {
    // Use Schlick's approximation for reflectance.
    var r0 = (1.0 - refractionIndex) / (1.0 + refractionIndex);
    r0 *= r0;
    return r0 + (1.0 - r0) * pow((1.0 - cosine), 5.0);
  }

`,ii=se`
  const BV_MAX_STACK_DEPTH = 16;
  const EPSILON = 0.001;

  ${ei}
  ${_t}
  ${ti}
  ${ni}
  ${ri}
  ${Ht}
  ${Qn}
  ${si}

  @group(0) @binding(0) var<storage, read_write> raytraceImageBuffer: array<vec3f>;
  @group(0) @binding(1) var<storage, read_write> rngStateBuffer: array<u32>;
  @group(0) @binding(2) var<uniform> commonUniforms: CommonUniforms;
  @group(0) @binding(3) var<uniform> cameraUniforms: Camera;

  @group(1) @binding(0) var<storage, read> faces: array<Face>;
  @group(1) @binding(1) var<storage, read> AABBs: array<AABB>;
  @group(1) @binding(2) var<storage, read> materials: array<Material>;

  override WORKGROUP_SIZE_X: u32;
  override WORKGROUP_SIZE_Y: u32;
  override OBJECTS_COUNT_IN_SCENE: u32;
  override MAX_BVs_COUNT_PER_MESH: u32;
  override MAX_FACES_COUNT_PER_MESH: u32;

  @compute @workgroup_size(WORKGROUP_SIZE_X, WORKGROUP_SIZE_Y)
  fn main(@builtin(global_invocation_id) globalInvocationId : vec3<u32>,) {
    if (any(globalInvocationId.xy > cameraUniforms.viewportSize)) {
      return;
    }

    let pos = globalInvocationId.xy;
    let x = f32(pos.x);
    let y = f32(pos.y);
    let idx = pos.x + pos.y * cameraUniforms.viewportSize.x;

    var rngState = rngStateBuffer[idx];

    var camera = cameraUniforms;
    initCamera(&camera);
    
    var hitRec: HitRecord;

    var r = getCameraRay(&camera, x, y, &rngState);

    var color = vec3f(0);

    var mtlStack: array<Material, 16>;
    var bLoop = true;
    var i = 0u;

    while(bLoop && rayIntersectBVH(&r, &hitRec, positiveUniverseInterval)) {
      var scattered: Ray;
      var material = materials[hitRec.materialIdx];
      var albedo = material.albedo;
      
      mtlStack[i] = material;

      if (commonUniforms.debugNormals == 1u) {
        color = (hitRec.normal + 1) * 0.5;
        break;
      }

      switch material.materialType {
        case 0: {
          color = material.albedo;
          bLoop = false;
          break;
        }
        case 1: {
          if (i < commonUniforms.maxBounces) {
            var scatters = scatterMetal(&material, &r, &scattered, &hitRec, &albedo, &rngState);
            if (scatters) {
              i++;
              r = scattered;
            } else {
              color = vec3f(0);
              bLoop = false;
              i = 0u;
            }
          } else {
            color = material.albedo;
            bLoop = false;
          }
          break;
        }
        case 2: {
          if (i < commonUniforms.maxBounces) {
            var scatters = scatterDielectric(&material, &r, &scattered, &hitRec, &albedo, &rngState);  
            r = scattered;
            i++;
          } else {
            color = mtlStack[i].albedo;
            bLoop = false;
          }
          break;
        }
        case 3: {
          var scatters = scatterLambertian(&material, &r, &scattered, &hitRec, &albedo, &rngState);
          if (i < commonUniforms.maxBounces) {
            i++;
            r = scattered;
          } else {
            bLoop = false;
          }
          break;
        }
        default: {
          // ... 
        }
      }
    }


    while (i > 0) {
      i--;
      color *= mtlStack[i].albedo;
    }

    var pixel = raytraceImageBuffer[idx];

    if (commonUniforms.frameCounter == 0) {
      pixel = vec3f(0);
    }

    pixel += color;
    raytraceImageBuffer[idx] = pixel;

    rngStateBuffer[idx] = rngState;
  }
`;vn.extend(Fr);const er=16,tr=16,nr=1,pt=[Math.random(),Math.random(),Math.random()];let $e=0,Ne=4,rr=0,jt=0,qt=0;const ai=document.getElementById("frame-count"),oi=document.getElementById("time-expired"),ui=document.getElementById("progress"),sr=document.getElementById("progress-percent"),ie={"Max Samples":5e3,"Ray Bounces Count":Ne,"Debug BVH":!1,"Debug Normals":!1,"Use Phong Shading":!0,"Crystal Suzanne":!1},ir=document.getElementById("toggle-header"),ci=document.getElementById("header-body"),P=document.createElement("canvas");P.setAttribute("id","c"),Ti();const li=await navigator.gpu.requestAdapter(),$=await li.requestDevice({requiredLimits:{}}),ar=P.getContext("webgpu"),Xt=navigator.gpu.getPreferredCanvasFormat?navigator.gpu.getPreferredCanvasFormat():"bgra8unorm";ar.configure({device:$,format:Xt,alphaMode:"premultiplied"});const Ge=new Gt(P,ce(0,0,3.5),60,P.width/P.height),He=new Ce($);await He.loadModels();const or=$.createShaderModule({code:Qs}),hi=$.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}}]}),ur=$.createRenderPipeline({layout:$.createPipelineLayout({bindGroupLayouts:[hi]}),vertex:{module:or,entryPoint:"vertexMain"},fragment:{module:or,entryPoint:"fragmentMain",targets:[{format:Xt}]},primitive:{topology:"triangle-list",cullMode:"back"}}),di=$.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}}]}),cr=$.createShaderModule({code:Js}),lr=$.createRenderPipeline({layout:$.createPipelineLayout({bindGroupLayouts:[di]}),vertex:{module:cr,entryPoint:"vertexMain"},fragment:{module:cr,entryPoint:"fragmentMain",targets:[{format:Xt,blend:{color:{srcFactor:"one",dstFactor:"one-minus-src-alpha"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha"}}}]},primitive:{topology:"line-list"}}),_i=$.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}]}),pi=$.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]}),fi=$.createShaderModule({code:ii}),Yt=$.createComputePipeline({layout:$.createPipelineLayout({bindGroupLayouts:[_i,pi]}),compute:{module:fi,entryPoint:"main",constants:{WORKGROUP_SIZE_X:er,WORKGROUP_SIZE_Y:tr,OBJECTS_COUNT_IN_SCENE:Ce.MODELS_COUNT,MAX_BVs_COUNT_PER_MESH:Ce.MAX_NUM_BVs_PER_MESH,MAX_FACES_COUNT_PER_MESH:Ce.MAX_NUM_FACES_PER_MESH}}}),Kt=$.createBuffer({size:Float32Array.BYTES_PER_ELEMENT*4*P.width*P.height,usage:GPUBufferUsage.STORAGE});Kt.label="Raytraced Image Buffer";const ft=$.createBuffer({size:Uint32Array.BYTES_PER_ELEMENT*P.width*P.height,usage:GPUBufferUsage.STORAGE,mappedAtCreation:!0});ft.label="RNG State Buffer";const mi=new Uint32Array(ft.getMappedRange());for(let t=0;t<P.width*P.height;t++)mi[t]=t;ft.unmap();const gi=qn(_t),Wt=kn(gi.structs.CommonUniforms),mt=$.createBuffer({size:Wt.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});mt.label="Common Uniforms Buffer";const yi=qn(Ht),gt=kn(yi.structs.Camera),yt=$.createBuffer({size:gt.arrayBuffer.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});yt.label="Camera Uniforms Buffer",gt.set({viewportSize:[P.width,P.height],imageWidth:P.width,aspectRatio:Ge.aspectRatio,vfov:Ge.vfov,lookFrom:[0,0,2],lookAt:[0,0,0],vup:[0,1,0],defocusAngle:0,focusDist:3.4});const Zt=$.createBuffer({size:16*Float32Array.BYTES_PER_ELEMENT,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});Zt.label="Camera ViewProjection Matrix";const vi=$.createBindGroup({layout:ur.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:Kt}},{binding:1,resource:{buffer:yt}},{binding:2,resource:{buffer:mt}}]}),bi=$.createBindGroup({layout:lr.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:He.aabbsBuffer}},{binding:1,resource:{buffer:Zt}}]}),xi=$.createBindGroup({layout:Yt.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:Kt}},{binding:1,resource:{buffer:ft}},{binding:2,resource:{buffer:mt}},{binding:3,resource:{buffer:yt}}]}),wi=$.createBindGroup({layout:Yt.getBindGroupLayout(1),entries:[{binding:0,resource:{buffer:He.facesBuffer}},{binding:1,resource:{buffer:He.aabbsBuffer}},{binding:2,resource:{buffer:He.materialsBuffer}}]}),hr={colorAttachments:[{view:null,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]};document.body.classList.add("loaded"),document.body.appendChild(P),P.addEventListener("mousedown",Si),P.addEventListener("mouseup",Ai),P.addEventListener("wheel",Mi,{passive:!0}),P.addEventListener("touchstart",ki),P.addEventListener("touchend",Ei),ir.addEventListener("click",()=>{ir.classList.toggle("active"),ci.classList.toggle("active")}),Ii(),requestAnimationFrame(pr);function ki(t){t.preventDefault(),Ne=nr,P.addEventListener("touchmove",dr)}function Ei(t){t.preventDefault(),Ne=ie["Ray Bounces Count"],P.removeEventListener("touchmove",dr)}function dr(t){t.preventDefault(),we()}function Si(t){Ne=nr,P.addEventListener("mousemove",_r)}function _r(t){we()}function Ai(t){Ne=ie["Ray Bounces Count"],P.removeEventListener("mousemove",_r)}function Mi(){we()}function pr(){const t=performance.now(),e=t-jt;jt=t,qt+=e,requestAnimationFrame(pr),ai.textContent=$e.toString(),oi.textContent=vn.duration(qt).format("mm:ss");const n=$e/ie["Max Samples"]*100;if(ui.style.width=`${n}%`,sr.className=n<5?"docked-left":"docked-right",sr.textContent=`${n.toFixed(0)}%`,$e===ie["Max Samples"])return;Ge.tick(),pt[0]=Math.random()*16777215,pt[1]=Math.random()*16777215,pt[2]=Math.random()*16777215,Wt.set({seed:pt,frameCounter:$e,maxBounces:Ne,flatShading:rr,debugNormals:ie["Debug Normals"]?1:0}),$.queue.writeBuffer(mt,0,Wt.arrayBuffer),gt.set({lookFrom:Ge.position,lookAt:Ge.target}),$.queue.writeBuffer(yt,0,gt.arrayBuffer),$.queue.writeBuffer(Zt,0,Ge.viewProjectionMatrix);const r=$.createCommandEncoder(),s=r.beginComputePass();s.setPipeline(Yt),s.setBindGroup(0,xi),s.setBindGroup(1,wi),s.dispatchWorkgroups(Math.ceil(P.width/er),Math.ceil(P.height/tr),1),s.end(),hr.colorAttachments[0].view=ar.getCurrentTexture().createView();const i=r.beginRenderPass(hr);i.setPipeline(ur),i.setBindGroup(0,vi),i.draw(6),ie["Debug BVH"]&&(i.setPipeline(lr),i.setBindGroup(0,bi),i.draw(2,Ce.AABBS_COUNT*12)),i.end(),$.queue.submit([r.finish()]),$e++}function Ti(){const t=Math.min(innerWidth,1920),e=Math.min(innerHeight,1080);P.width=t,P.height=e,P.style.width=`${t}px`,P.style.height=`${e}px`,P.style.marginTop=`${-e*.5}px`,P.style.marginLeft=`${-t*.5}px`}function we(){$e=0,jt=performance.now(),qt=0}function Ii(){const t=new Lr;t.close(),t.width=400,t.add(ie,"Debug BVH"),t.add(ie,"Debug Normals").onChange(()=>{we()}),t.add(ie,"Use Phong Shading").onChange(e=>{rr=e?0:1,we()}),t.add(ie,"Crystal Suzanne").onChange(e=>{He.isSuzanneGlass=e,we()}),t.add(ie,"Ray Bounces Count",1,16,1).onChange(e=>{we(),Ne=e}),t.add(ie,"Max Samples",1,1e4,5).onChange(e=>{we()})}})();
